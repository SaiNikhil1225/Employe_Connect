import React, { useState, useCallback, useMemo } from 'react';\nimport {\n  MessageSquare,\n  Plus,\n  Edit3,\n  Trash2,\n  Copy,\n  Search,\n  Star,\n  Clock,\n  User,\n  Tag,\n  Save,\n  X,\n  Send,\n  Zap\n} from 'lucide-react';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Badge } from '@/components/ui/badge';\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from '@/components/ui/dialog';\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select';\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from '@/components/ui/dropdown-menu';\nimport { Switch } from '@/components/ui/switch';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { toast } from 'sonner';\n\ninterface CannedResponse {\n  id: string;\n  name: string;\n  category: string;\n  content: string;\n  shortcut: string;\n  variables: string[];\n  tags: string[];\n  isPublic: boolean;\n  isFavorite: boolean;\n  usageCount: number;\n  createdBy: string;\n  createdAt: string;\n  updatedAt: string;\n}\n\ninterface CannedResponsesProps {\n  onSelectResponse?: (response: CannedResponse) => void;\n  onInsertResponse?: (content: string) => void;\n  className?: string;\n}\n\ninterface ResponseEditorProps {\n  response?: CannedResponse;\n  isOpen: boolean;\n  onClose: () => void;\n  onSave: (response: Omit<CannedResponse, 'id' | 'createdAt' | 'updatedAt' | 'usageCount'>) => void;\n}\n\ninterface QuickInsertProps {\n  responses: CannedResponse[];\n  onInsert: (content: string) => void;\n  className?: string;\n}\n\n// Default canned responses\nconst DEFAULT_RESPONSES: CannedResponse[] = [\n  {\n    id: '1',\n    name: 'Welcome & Acknowledge',\n    category: 'Greeting',\n    content: 'Hi {{customerName}},\\n\\nThank you for contacting {{companyName}} support. I\\'ve received your request regarding \"{{ticketSubject}}\" and I\\'m here to help.\\n\\nI\\'ll review your case and get back to you within {{responseTime}}.\\n\\nBest regards,\\n{{agentName}}',\n    shortcut: '/welcome',\n    variables: ['customerName', 'companyName', 'ticketSubject', 'responseTime', 'agentName'],\n    tags: ['greeting', 'acknowledgment', 'welcome'],\n    isPublic: true,\n    isFavorite: true,\n    usageCount: 156,\n    createdBy: 'admin',\n    createdAt: '2024-01-01T10:00:00Z',\n    updatedAt: '2024-01-05T14:30:00Z',\n  },\n  {\n    id: '2',\n    name: 'Request More Information',\n    category: 'Information Request',\n    content: 'Hi {{customerName}},\\n\\nTo better assist you with this issue, I\\'ll need some additional information:\\n\\n• Please provide more details about when this issue started\\n• Are there any error messages? If so, please share the exact text\\n• What steps have you already tried to resolve this?\\n• {{additionalQuestions}}\\n\\nOnce I have this information, I\\'ll be able to provide you with a more targeted solution.\\n\\nThank you for your patience.\\n\\nBest regards,\\n{{agentName}}',\n    shortcut: '/moreinfo',\n    variables: ['customerName', 'additionalQuestions', 'agentName'],\n    tags: ['information', 'clarification', 'troubleshooting'],\n    isPublic: true,\n    isFavorite: true,\n    usageCount: 89,\n    createdBy: 'admin',\n    createdAt: '2024-01-02T09:15:00Z',\n    updatedAt: '2024-01-02T09:15:00Z',\n  },\n  {\n    id: '3',\n    name: 'Issue Resolved',\n    category: 'Resolution',\n    content: 'Hi {{customerName}},\\n\\nGreat news! I\\'ve successfully resolved the issue you reported.\\n\\nSummary of what was done:\\n{{resolutionSummary}}\\n\\nPlease test the solution and confirm that everything is working correctly. If you experience any further issues or have questions, please don\\'t hesitate to reach out.\\n\\nIs there anything else I can help you with today?\\n\\nBest regards,\\n{{agentName}}',\n    shortcut: '/resolved',\n    variables: ['customerName', 'resolutionSummary', 'agentName'],\n    tags: ['resolution', 'completion', 'followup'],\n    isPublic: true,\n    isFavorite: false,\n    usageCount: 234,\n    createdBy: 'admin',\n    createdAt: '2024-01-03T11:20:00Z',\n    updatedAt: '2024-01-06T16:45:00Z',\n  },\n  {\n    id: '4',\n    name: 'Escalation Notice',\n    category: 'Escalation',\n    content: 'Hi {{customerName}},\\n\\nI want to keep you updated on the status of your ticket.\\n\\nDue to the complexity of your request, I\\'ve escalated this to our {{specialistTeam}} team for further assistance. They have the specialized expertise needed to resolve your issue.\\n\\nExpected timeframe: {{escalationTimeframe}}\\nEscalation reference: {{escalationReference}}\\n\\nYou can expect an update from our specialist team within {{updateTimeframe}}. In the meantime, if you have any questions, please don\\'t hesitate to reach out.\\n\\nThank you for your patience.\\n\\nBest regards,\\n{{agentName}}',\n    shortcut: '/escalate',\n    variables: ['customerName', 'specialistTeam', 'escalationTimeframe', 'escalationReference', 'updateTimeframe', 'agentName'],\n    tags: ['escalation', 'specialist', 'complex'],\n    isPublic: true,\n    isFavorite: false,\n    usageCount: 67,\n    createdBy: 'admin',\n    createdAt: '2024-01-04T14:00:00Z',\n    updatedAt: '2024-01-04T14:00:00Z',\n  },\n  {\n    id: '5',\n    name: 'Closing Follow-up',\n    category: 'Closure',\n    content: 'Hi {{customerName}},\\n\\nI hope this message finds you well. I\\'m following up on the support case we recently resolved for you.\\n\\nJust to confirm:\\n✅ Has the issue been fully resolved?\\n✅ Are you satisfied with the solution provided?\\n✅ Do you need any additional assistance?\\n\\nIf everything looks good, I\\'ll close this ticket. However, if you need any further help or have questions, please reply to this message and I\\'ll be happy to assist.\\n\\nThank you for choosing {{companyName}}!\\n\\nBest regards,\\n{{agentName}}',\n    shortcut: '/followup',\n    variables: ['customerName', 'companyName', 'agentName'],\n    tags: ['closure', 'followup', 'satisfaction'],\n    isPublic: true,\n    isFavorite: true,\n    usageCount: 145,\n    createdBy: 'admin',\n    createdAt: '2024-01-05T16:30:00Z',\n    updatedAt: '2024-01-05T16:30:00Z',\n  },\n];\n\nconst RESPONSE_CATEGORIES = [\n  'All Categories',\n  'Greeting',\n  'Information Request',\n  'Resolution',\n  'Escalation',\n  'Closure',\n  'Troubleshooting',\n  'General',\n];\n\nconst COMMON_VARIABLES = [\n  'customerName',\n  'agentName',\n  'ticketId',\n  'ticketSubject',\n  'companyName',\n  'currentDate',\n  'responseTime',\n  'department',\n];\n\nexport const CannedResponses = React.memo<CannedResponsesProps>(({ \n  onSelectResponse, \n  onInsertResponse,\n  className = '' \n}) => {\n  const [responses, setResponses] = useState<CannedResponse[]>(DEFAULT_RESPONSES);\n  const [searchTerm, setSearchTerm] = useState('');\n  const [selectedCategory, setSelectedCategory] = useState('All Categories');\n  const [showFavoritesOnly, setShowFavoritesOnly] = useState(false);\n  const [isEditorOpen, setIsEditorOpen] = useState(false);\n  const [editingResponse, setEditingResponse] = useState<CannedResponse | undefined>();\n  const [showQuickInsert, setShowQuickInsert] = useState(false);\n\n  // Filter responses based on search, category, and favorites\n  const filteredResponses = useMemo(() => {\n    return responses.filter(response => {\n      const matchesSearch = response.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\n                          response.content.toLowerCase().includes(searchTerm.toLowerCase()) ||\n                          response.shortcut.toLowerCase().includes(searchTerm.toLowerCase()) ||\n                          response.tags.some(tag => tag.toLowerCase().includes(searchTerm.toLowerCase()));\n      \n      const matchesCategory = selectedCategory === 'All Categories' || \n                            response.category === selectedCategory;\n      \n      const matchesFavorites = !showFavoritesOnly || response.isFavorite;\n      \n      return matchesSearch && matchesCategory && matchesFavorites;\n    });\n  }, [responses, searchTerm, selectedCategory, showFavoritesOnly]);\n\n  // Handle response actions\n  const handleNewResponse = useCallback(() => {\n    setEditingResponse(undefined);\n    setIsEditorOpen(true);\n  }, []);\n\n  const handleEditResponse = useCallback((response: CannedResponse) => {\n    setEditingResponse(response);\n    setIsEditorOpen(true);\n  }, []);\n\n  const handleSaveResponse = useCallback((responseData: Omit<CannedResponse, 'id' | 'createdAt' | 'updatedAt' | 'usageCount'>) => {\n    const now = new Date().toISOString();\n    \n    if (editingResponse) {\n      // Update existing response\n      setResponses(prev => prev.map(r => \n        r.id === editingResponse.id \n          ? { ...responseData, id: r.id, createdAt: r.createdAt, updatedAt: now, usageCount: r.usageCount }\n          : r\n      ));\n      toast.success('Canned response updated successfully');\n    } else {\n      // Create new response\n      const newResponse: CannedResponse = {\n        ...responseData,\n        id: Date.now().toString(),\n        createdAt: now,\n        updatedAt: now,\n        usageCount: 0,\n      };\n      setResponses(prev => [newResponse, ...prev]);\n      toast.success('Canned response created successfully');\n    }\n    \n    setIsEditorOpen(false);\n  }, [editingResponse]);\n\n  const handleDeleteResponse = useCallback((responseId: string) => {\n    setResponses(prev => prev.filter(r => r.id !== responseId));\n    toast.success('Canned response deleted successfully');\n  }, []);\n\n  const handleToggleFavorite = useCallback((responseId: string) => {\n    setResponses(prev => prev.map(r => \n      r.id === responseId ? { ...r, isFavorite: !r.isFavorite } : r\n    ));\n  }, []);\n\n  const handleUseResponse = useCallback((response: CannedResponse) => {\n    // Increment usage count\n    setResponses(prev => prev.map(r => \n      r.id === response.id ? { ...r, usageCount: r.usageCount + 1 } : r\n    ));\n    \n    onSelectResponse?.(response);\n    onInsertResponse?.(response.content);\n    toast.success(`Canned response \"${response.name}\" inserted`);\n  }, [onSelectResponse, onInsertResponse]);\n\n  const handleDuplicateResponse = useCallback((response: CannedResponse) => {\n    const now = new Date().toISOString();\n    const duplicatedResponse: CannedResponse = {\n      ...response,\n      id: Date.now().toString(),\n      name: `${response.name} (Copy)`,\n      shortcut: `${response.shortcut}-copy`,\n      createdAt: now,\n      updatedAt: now,\n      usageCount: 0,\n      isFavorite: false,\n    };\n    \n    setResponses(prev => [duplicatedResponse, ...prev]);\n    toast.success('Canned response duplicated successfully');\n  }, []);\n\n  const mostUsedResponses = useMemo(() => {\n    return [...responses]\n      .sort((a, b) => b.usageCount - a.usageCount)\n      .slice(0, 6);\n  }, [responses]);\n\n  const favoriteResponses = useMemo(() => {\n    return responses.filter(r => r.isFavorite);\n  }, [responses]);\n\n  return (\n    <div className={`space-y-6 ${className}`}>\n      {/* Header */}\n      <div className=\"flex justify-between items-center\">\n        <div>\n          <h2 className=\"text-2xl font-bold tracking-tight\">Canned Responses</h2>\n          <p className=\"text-muted-foreground\">\n            Manage quick response templates with personalization variables\n          </p>\n        </div>\n        \n        <div className=\"flex gap-2\">\n          <Button \n            variant=\"outline\" \n            onClick={() => setShowQuickInsert(!showQuickInsert)}\n            className=\"gap-1\"\n          >\n            <Zap className=\"w-4 h-4\" />\n            Quick Insert\n          </Button>\n          \n          <Button onClick={handleNewResponse} className=\"gap-1\">\n            <Plus className=\"w-4 h-4\" />\n            New Response\n          </Button>\n        </div>\n      </div>\n\n      <Tabs defaultValue=\"all\" className=\"space-y-4\">\n        <TabsList>\n          <TabsTrigger value=\"all\">All Responses</TabsTrigger>\n          <TabsTrigger value=\"favorites\">\n            Favorites\n            {favoriteResponses.length > 0 && (\n              <Badge className=\"ml-2\">{favoriteResponses.length}</Badge>\n            )}\n          </TabsTrigger>\n          <TabsTrigger value=\"popular\">Most Used</TabsTrigger>\n        </TabsList>\n        \n        <TabsContent value=\"all\" className=\"space-y-4\">\n          {/* Filters */}\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"flex flex-col md:flex-row gap-4\">\n                <div className=\"flex-1\">\n                  <div className=\"relative\">\n                    <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4\" />\n                    <Input\n                      placeholder=\"Search responses, content, shortcuts, or tags...\"\n                      value={searchTerm}\n                      onChange={(e) => setSearchTerm(e.target.value)}\n                      className=\"pl-10\"\n                    />\n                  </div>\n                </div>\n                \n                <Select value={selectedCategory} onValueChange={setSelectedCategory}>\n                  <SelectTrigger className=\"w-full md:w-[180px]\">\n                    <SelectValue placeholder=\"Category\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {RESPONSE_CATEGORIES.map(category => (\n                      <SelectItem key={category} value={category}>\n                        {category}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n                \n                <div className=\"flex items-center space-x-2\">\n                  <Star className=\"w-4 h-4 text-yellow-500\" />\n                  <Label htmlFor=\"favorites\" className=\"text-sm font-medium\">\n                    Favorites only\n                  </Label>\n                  <Switch\n                    id=\"favorites\"\n                    checked={showFavoritesOnly}\n                    onCheckedChange={setShowFavoritesOnly}\n                  />\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Responses Grid */}\n          <ResponsesGrid \n            responses={filteredResponses}\n            onEdit={handleEditResponse}\n            onDelete={handleDeleteResponse}\n            onToggleFavorite={handleToggleFavorite}\n            onUse={handleUseResponse}\n            onDuplicate={handleDuplicateResponse}\n            emptyMessage=\"No responses found. Try adjusting your filters or create a new response.\"\n            onCreateNew={handleNewResponse}\n          />\n        </TabsContent>\n        \n        <TabsContent value=\"favorites\" className=\"space-y-4\">\n          <ResponsesGrid \n            responses={favoriteResponses}\n            onEdit={handleEditResponse}\n            onDelete={handleDeleteResponse}\n            onToggleFavorite={handleToggleFavorite}\n            onUse={handleUseResponse}\n            onDuplicate={handleDuplicateResponse}\n            emptyMessage=\"No favorite responses yet. Mark responses as favorites for quick access.\"\n            onCreateNew={handleNewResponse}\n          />\n        </TabsContent>\n        \n        <TabsContent value=\"popular\" className=\"space-y-4\">\n          <ResponsesGrid \n            responses={mostUsedResponses}\n            onEdit={handleEditResponse}\n            onDelete={handleDeleteResponse}\n            onToggleFavorite={handleToggleFavorite}\n            onUse={handleUseResponse}\n            onDuplicate={handleDuplicateResponse}\n            emptyMessage=\"No usage data available yet. Start using responses to see popular ones here.\"\n            onCreateNew={handleNewResponse}\n          />\n        </TabsContent>\n      </Tabs>\n\n      {/* Quick Insert Panel */}\n      {showQuickInsert && onInsertResponse && (\n        <QuickInsert\n          responses={responses}\n          onInsert={(content) => {\n            onInsertResponse(content);\n            setShowQuickInsert(false);\n          }}\n        />\n      )}\n\n      {/* Response Editor Dialog */}\n      <ResponseEditor\n        response={editingResponse}\n        isOpen={isEditorOpen}\n        onClose={() => setIsEditorOpen(false)}\n        onSave={handleSaveResponse}\n      />\n    </div>\n  );\n});\n\nCannedResponses.displayName = 'CannedResponses';\n\n// Responses Grid Component\ninterface ResponsesGridProps {\n  responses: CannedResponse[];\n  onEdit: (response: CannedResponse) => void;\n  onDelete: (id: string) => void;\n  onToggleFavorite: (id: string) => void;\n  onUse: (response: CannedResponse) => void;\n  onDuplicate: (response: CannedResponse) => void;\n  emptyMessage: string;\n  onCreateNew: () => void;\n}\n\nconst ResponsesGrid: React.FC<ResponsesGridProps> = ({\n  responses,\n  onEdit,\n  onDelete,\n  onToggleFavorite,\n  onUse,\n  onDuplicate,\n  emptyMessage,\n  onCreateNew,\n}) => {\n  if (responses.length === 0) {\n    return (\n      <div className=\"text-center py-12\">\n        <MessageSquare className=\"w-12 h-12 mx-auto mb-4 text-muted-foreground\" />\n        <h3 className=\"text-lg font-medium mb-2\">No responses found</h3>\n        <p className=\"text-muted-foreground mb-4\">{emptyMessage}</p>\n        <Button onClick={onCreateNew} variant=\"outline\">\n          <Plus className=\"w-4 h-4 mr-2\" />\n          Create Response\n        </Button>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-4\">\n      {responses.map(response => (\n        <Card key={response.id} className=\"hover:shadow-md transition-shadow\">\n          <CardHeader>\n            <div className=\"flex items-start justify-between\">\n              <div className=\"space-y-1\">\n                <CardTitle className=\"text-lg flex items-center gap-2\">\n                  {response.name}\n                  {response.isFavorite && (\n                    <Star className=\"w-4 h-4 text-yellow-500 fill-current\" />\n                  )}\n                </CardTitle>\n                <CardDescription>\n                  {response.category} • {response.shortcut} • Used {response.usageCount} times\n                </CardDescription>\n              </div>\n              \n              <DropdownMenu>\n                <DropdownMenuTrigger asChild>\n                  <Button variant=\"ghost\" size=\"sm\">\n                    <svg className=\"w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                      <path d=\"M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z\" />\n                    </svg>\n                  </Button>\n                </DropdownMenuTrigger>\n                <DropdownMenuContent align=\"end\">\n                  <DropdownMenuItem onClick={() => onUse(response)}>\n                    <Send className=\"w-4 h-4 mr-2\" />\n                    Use Response\n                  </DropdownMenuItem>\n                  <DropdownMenuItem onClick={() => onEdit(response)}>\n                    <Edit3 className=\"w-4 h-4 mr-2\" />\n                    Edit\n                  </DropdownMenuItem>\n                  <DropdownMenuItem onClick={() => onDuplicate(response)}>\n                    <Copy className=\"w-4 h-4 mr-2\" />\n                    Duplicate\n                  </DropdownMenuItem>\n                  <DropdownMenuItem onClick={() => onToggleFavorite(response.id)}>\n                    <Star className={`w-4 h-4 mr-2 ${response.isFavorite ? 'text-yellow-500' : ''}`} />\n                    {response.isFavorite ? 'Remove from Favorites' : 'Add to Favorites'}\n                  </DropdownMenuItem>\n                  <DropdownMenuSeparator />\n                  <DropdownMenuItem \n                    onClick={() => onDelete(response.id)}\n                    className=\"text-red-600 focus:text-red-600\"\n                  >\n                    <Trash2 className=\"w-4 h-4 mr-2\" />\n                    Delete\n                  </DropdownMenuItem>\n                </DropdownMenuContent>\n              </DropdownMenu>\n            </div>\n          </CardHeader>\n          \n          <CardContent className=\"space-y-4\">\n            <div>\n              <p className=\"text-sm text-muted-foreground bg-gray-50 dark:bg-gray-800 p-3 rounded max-h-24 overflow-hidden relative\">\n                {response.content.split('\\n').slice(0, 3).join(' ')}\n                {response.content.split('\\n').length > 3 && (\n                  <div className=\"absolute bottom-0 left-0 right-0 h-6 bg-gradient-to-t from-gray-50 dark:from-gray-800 to-transparent\" />\n                )}\n              </p>\n            </div>\n            \n            {response.tags.length > 0 && (\n              <div className=\"flex flex-wrap gap-1\">\n                {response.tags.slice(0, 3).map(tag => (\n                  <Badge key={tag} variant=\"secondary\" className=\"text-xs\">\n                    {tag}\n                  </Badge>\n                ))}\n                {response.tags.length > 3 && (\n                  <Badge variant=\"outline\" className=\"text-xs\">\n                    +{response.tags.length - 3} more\n                  </Badge>\n                )}\n              </div>\n            )}\n            \n            <div className=\"flex gap-2\">\n              <Button \n                onClick={() => onUse(response)}\n                className=\"flex-1\"\n                size=\"sm\"\n              >\n                <Send className=\"w-4 h-4 mr-1\" />\n                Use Response\n              </Button>\n              <Button \n                onClick={() => onEdit(response)}\n                variant=\"outline\"\n                size=\"sm\"\n              >\n                <Edit3 className=\"w-4 h-4\" />\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      ))}\n    </div>\n  );\n};\n\n// Response Editor Component\nconst ResponseEditor: React.FC<ResponseEditorProps> = ({ \n  response, \n  isOpen, \n  onClose, \n  onSave \n}) => {\n  const [formData, setFormData] = useState({\n    name: '',\n    category: 'General',\n    content: '',\n    shortcut: '',\n    variables: [] as string[],\n    tags: [] as string[],\n    isPublic: true,\n    isFavorite: false,\n    createdBy: 'current-user',\n  });\n  \n  const [newTag, setNewTag] = useState('');\n  const [newVariable, setNewVariable] = useState('');\n\n  // Initialize form data when response changes\n  React.useEffect(() => {\n    if (response) {\n      setFormData({\n        name: response.name,\n        category: response.category,\n        content: response.content,\n        shortcut: response.shortcut,\n        variables: [...response.variables],\n        tags: [...response.tags],\n        isPublic: response.isPublic,\n        isFavorite: response.isFavorite,\n        createdBy: response.createdBy,\n      });\n    } else {\n      setFormData({\n        name: '',\n        category: 'General',\n        content: '',\n        shortcut: '',\n        variables: [],\n        tags: [],\n        isPublic: true,\n        isFavorite: false,\n        createdBy: 'current-user',\n      });\n    }\n  }, [response, isOpen]);\n\n  const handleSave = () => {\n    if (!formData.name.trim() || !formData.content.trim()) {\n      toast.error('Please fill in all required fields');\n      return;\n    }\n    \n    if (formData.shortcut && !formData.shortcut.startsWith('/')) {\n      setFormData(prev => ({ ...prev, shortcut: `/${prev.shortcut}` }));\n    }\n    \n    onSave(formData);\n  };\n\n  const handleAddTag = () => {\n    if (newTag.trim() && !formData.tags.includes(newTag.trim().toLowerCase())) {\n      setFormData(prev => ({ \n        ...prev, \n        tags: [...prev.tags, newTag.trim().toLowerCase()] \n      }));\n      setNewTag('');\n    }\n  };\n\n  const handleRemoveTag = (tag: string) => {\n    setFormData(prev => ({ \n      ...prev, \n      tags: prev.tags.filter(t => t !== tag) \n    }));\n  };\n\n  const handleAddVariable = () => {\n    if (newVariable.trim() && !formData.variables.includes(newVariable.trim())) {\n      setFormData(prev => ({ \n        ...prev, \n        variables: [...prev.variables, newVariable.trim()] \n      }));\n      setNewVariable('');\n    }\n  };\n\n  const handleRemoveVariable = (variable: string) => {\n    setFormData(prev => ({ \n      ...prev, \n      variables: prev.variables.filter(v => v !== variable) \n    }));\n  };\n\n  const addCommonVariable = (variable: string) => {\n    if (!formData.variables.includes(variable)) {\n      setFormData(prev => ({ \n        ...prev, \n        variables: [...prev.variables, variable] \n      }));\n    }\n  };\n\n  return (\n    <Dialog open={isOpen} onOpenChange={onClose}>\n      <DialogContent className=\"sm:max-w-[700px] max-h-[90vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle>\n            {response ? 'Edit Canned Response' : 'Create New Canned Response'}\n          </DialogTitle>\n          <DialogDescription>\n            Create quick response templates with personalization variables for faster customer communication\n          </DialogDescription>\n        </DialogHeader>\n        \n        <div className=\"space-y-6\">\n          {/* Basic Information */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"name\">Response Name *</Label>\n              <Input\n                id=\"name\"\n                value={formData.name}\n                onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                placeholder=\"e.g., Welcome Message\"\n              />\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label htmlFor=\"category\">Category</Label>\n              <Select \n                value={formData.category} \n                onValueChange={(category) => setFormData({ ...formData, category })}\n              >\n                <SelectTrigger>\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {RESPONSE_CATEGORIES.slice(1).map(category => (\n                    <SelectItem key={category} value={category}>\n                      {category}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n          \n          <div className=\"space-y-2\">\n            <Label htmlFor=\"shortcut\">Shortcut (Optional)</Label>\n            <Input\n              id=\"shortcut\"\n              value={formData.shortcut}\n              onChange={(e) => setFormData({ ...formData, shortcut: e.target.value })}\n              placeholder=\"e.g., /welcome (will be auto-prefixed with /)\"\n            />\n            <p className=\"text-xs text-muted-foreground\">\n              Type this shortcut in message fields for quick insertion\n            </p>\n          </div>\n          \n          {/* Content */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"content\">Response Content *</Label>\n            <Textarea\n              id=\"content\"\n              value={formData.content}\n              onChange={(e) => setFormData({ ...formData, content: e.target.value })}\n              rows={8}\n              placeholder=\"Enter your response content here...\\n\\nUse {{variables}} for dynamic content like {{customerName}}, {{agentName}}, etc.\"\n            />\n            <p className=\"text-xs text-muted-foreground\">\n              Use double curly braces for variables: {{'{'}}{'{'}variableName{'}'}{'}'}\n            </p>\n          </div>\n          \n          {/* Variables */}\n          <div className=\"space-y-3\">\n            <Label>Variables</Label>\n            <div className=\"space-y-2\">\n              <div className=\"flex gap-2\">\n                <Input\n                  value={newVariable}\n                  onChange={(e) => setNewVariable(e.target.value)}\n                  placeholder=\"Enter variable name (e.g., customerName)\"\n                  onKeyPress={(e) => e.key === 'Enter' && handleAddVariable()}\n                />\n                <Button onClick={handleAddVariable} size=\"sm\">\n                  Add\n                </Button>\n              </div>\n              \n              <div className=\"flex flex-wrap gap-1\">\n                <span className=\"text-sm text-muted-foreground mr-2\">Quick add:</span>\n                {COMMON_VARIABLES.filter(v => !formData.variables.includes(v)).map(variable => (\n                  <Button\n                    key={variable}\n                    variant=\"outline\"\n                    size=\"sm\"\n                    className=\"text-xs h-6\"\n                    onClick={() => addCommonVariable(variable)}\n                  >\n                    {variable}\n                  </Button>\n                ))}\n              </div>\n              \n              {formData.variables.length > 0 && (\n                <div className=\"flex flex-wrap gap-1\">\n                  {formData.variables.map(variable => (\n                    <Badge key={variable} className=\"gap-1\">\n                      {variable}\n                      <button\n                        onClick={() => handleRemoveVariable(variable)}\n                        className=\"ml-1 hover:bg-white/20 rounded\"\n                      >\n                        <X className=\"w-3 h-3\" />\n                      </button>\n                    </Badge>\n                  ))}\n                </div>\n              )}\n            </div>\n          </div>\n          \n          {/* Tags */}\n          <div className=\"space-y-3\">\n            <Label>Tags</Label>\n            <div className=\"space-y-2\">\n              <div className=\"flex gap-2\">\n                <Input\n                  value={newTag}\n                  onChange={(e) => setNewTag(e.target.value)}\n                  placeholder=\"Add tags for organization\"\n                  onKeyPress={(e) => e.key === 'Enter' && handleAddTag()}\n                />\n                <Button onClick={handleAddTag} size=\"sm\">\n                  Add\n                </Button>\n              </div>\n              \n              {formData.tags.length > 0 && (\n                <div className=\"flex flex-wrap gap-1\">\n                  {formData.tags.map(tag => (\n                    <Badge key={tag} variant=\"secondary\" className=\"gap-1\">\n                      {tag}\n                      <button\n                        onClick={() => handleRemoveTag(tag)}\n                        className=\"ml-1 hover:bg-white/20 rounded\"\n                      >\n                        <X className=\"w-3 h-3\" />\n                      </button>\n                    </Badge>\n                  ))}\n                </div>\n              )}\n            </div>\n          </div>\n          \n          {/* Settings */}\n          <div className=\"space-y-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <Label>Public Response</Label>\n                <p className=\"text-sm text-muted-foreground\">\n                  Allow other team members to use this response\n                </p>\n              </div>\n              <Switch\n                checked={formData.isPublic}\n                onCheckedChange={(isPublic) => setFormData({ ...formData, isPublic })}\n              />\n            </div>\n            \n            <div className=\"flex items-center justify-between\">\n              <div>\n                <Label>Add to Favorites</Label>\n                <p className=\"text-sm text-muted-foreground\">\n                  Mark this response as a favorite for quick access\n                </p>\n              </div>\n              <Switch\n                checked={formData.isFavorite}\n                onCheckedChange={(isFavorite) => setFormData({ ...formData, isFavorite })}\n              />\n            </div>\n          </div>\n        </div>\n        \n        <DialogFooter>\n          <Button variant=\"outline\" onClick={onClose}>\n            Cancel\n          </Button>\n          <Button onClick={handleSave}>\n            <Save className=\"w-4 h-4 mr-2\" />\n            {response ? 'Update Response' : 'Create Response'}\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n};\n\n// Quick Insert Component\nconst QuickInsert: React.FC<QuickInsertProps> = ({ responses, onInsert, className = '' }) => {\n  const [searchTerm, setSearchTerm] = useState('');\n  const [selectedResponse, setSelectedResponse] = useState<CannedResponse | null>(null);\n  const [variableValues, setVariableValues] = useState<Record<string, string>>({});\n\n  const filteredResponses = useMemo(() => {\n    return responses.filter(response => \n      response.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\n      response.shortcut.toLowerCase().includes(searchTerm.toLowerCase())\n    ).slice(0, 6);\n  }, [responses, searchTerm]);\n\n  const handleSelectResponse = (response: CannedResponse) => {\n    setSelectedResponse(response);\n    \n    // Initialize variable values with defaults\n    const initialValues: Record<string, string> = {};\n    response.variables.forEach(variable => {\n      switch (variable) {\n        case 'currentDate':\n          initialValues[variable] = new Date().toLocaleDateString();\n          break;\n        case 'agentName':\n          initialValues[variable] = 'Your Name';\n          break;\n        case 'companyName':\n          initialValues[variable] = 'Your Company';\n          break;\n        default:\n          initialValues[variable] = '';\n      }\n    });\n    setVariableValues(initialValues);\n  };\n\n  const handleInsert = () => {\n    if (!selectedResponse) return;\n    \n    let content = selectedResponse.content;\n    Object.entries(variableValues).forEach(([variable, value]) => {\n      content = content.replace(new RegExp(`\\{\\{${variable}\\}\\}`, 'g'), value || `{{${variable}}}`);\n    });\n    \n    onInsert(content);\n    setSelectedResponse(null);\n    setVariableValues({});\n    setSearchTerm('');\n  };\n\n  if (selectedResponse) {\n    return (\n      <Card className={`border-blue-200 ${className}`}>\n        <CardHeader>\n          <div className=\"flex items-center justify-between\">\n            <CardTitle className=\"text-lg\">\n              Customize: {selectedResponse.name}\n            </CardTitle>\n            <Button \n              variant=\"ghost\" \n              size=\"sm\" \n              onClick={() => setSelectedResponse(null)}\n            >\n              <X className=\"w-4 h-4\" />\n            </Button>\n          </div>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          {selectedResponse.variables.length > 0 && (\n            <div className=\"space-y-2\">\n              <Label className=\"text-sm font-medium\">Fill in variables:</Label>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                {selectedResponse.variables.map(variable => (\n                  <div key={variable}>\n                    <Label htmlFor={variable} className=\"text-xs\">\n                      {variable}\n                    </Label>\n                    <Input\n                      id={variable}\n                      size=\"sm\"\n                      value={variableValues[variable] || ''}\n                      onChange={(e) => setVariableValues(prev => ({\n                        ...prev,\n                        [variable]: e.target.value\n                      }))}\n                      placeholder={`Enter ${variable}`}\n                    />\n                  </div>\n                ))}\n              </div>\n            </div>\n          )}\n          \n          <div className=\"flex gap-2\">\n            <Button onClick={handleInsert} className=\"flex-1\">\n              Insert Response\n            </Button>\n            <Button \n              variant=\"outline\" \n              onClick={() => setSelectedResponse(null)}\n            >\n              Cancel\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <Card className={`border-green-200 ${className}`}>\n      <CardHeader>\n        <CardTitle className=\"text-lg flex items-center gap-2\">\n          <Zap className=\"w-5 h-5 text-green-600\" />\n          Quick Insert Response\n        </CardTitle>\n      </CardHeader>\n      <CardContent className=\"space-y-4\">\n        <div className=\"relative\">\n          <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4\" />\n          <Input\n            placeholder=\"Search responses or type shortcut...\"\n            value={searchTerm}\n            onChange={(e) => setSearchTerm(e.target.value)}\n            className=\"pl-10\"\n          />\n        </div>\n        \n        <div className=\"space-y-2\">\n          {filteredResponses.map(response => (\n            <div\n              key={response.id}\n              className=\"flex items-center justify-between p-2 hover:bg-gray-50 dark:hover:bg-gray-800 rounded cursor-pointer\"\n              onClick={() => handleSelectResponse(response)}\n            >\n              <div>\n                <div className=\"font-medium text-sm\">{response.name}</div>\n                <div className=\"text-xs text-muted-foreground\">\n                  {response.shortcut} • {response.category}\n                </div>\n              </div>\n              <Button size=\"sm\" variant=\"outline\">\n                Use\n              </Button>\n            </div>\n          ))}\n          \n          {filteredResponses.length === 0 && searchTerm && (\n            <p className=\"text-sm text-muted-foreground text-center py-4\">\n              No responses found for \"{searchTerm}\"\n            </p>\n          )}\n        </div>\n      </CardContent>\n    </Card>\n  );\n};\n\nexport { QuickInsert };\nexport default CannedResponses;"