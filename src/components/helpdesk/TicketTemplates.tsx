import React, { useState, useCallback, useMemo } from 'react';\nimport {\n  FileText,\n  Plus,\n  Edit3,\n  Trash2,\n  Copy,\n  Search,\n  Filter,\n  Star,\n  Clock,\n  User,\n  Tag,\n  Save,\n  X,\n  Eye\n} from 'lucide-react';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Badge } from '@/components/ui/badge';\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger\n} from '@/components/ui/dialog';\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select';\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from '@/components/ui/dropdown-menu';\nimport { Switch } from '@/components/ui/switch';\nimport { toast } from 'sonner';\nimport type { HelpdeskTicket } from '@/types/helpdesk';\n\ninterface TicketTemplate {\n  id: string;\n  name: string;\n  category: string;\n  subject: string;\n  content: string;\n  tags: string[];\n  variables: string[];\n  isPublic: boolean;\n  isFavorite: boolean;\n  usageCount: number;\n  createdBy: string;\n  createdAt: string;\n  updatedAt: string;\n}\n\ninterface TicketTemplatesProps {\n  onSelectTemplate?: (template: TicketTemplate) => void;\n  className?: string;\n}\n\ninterface TemplateEditorProps {\n  template?: TicketTemplate;\n  isOpen: boolean;\n  onClose: () => void;\n  onSave: (template: Omit<TicketTemplate, 'id' | 'createdAt' | 'updatedAt' | 'usageCount'>) => void;\n}\n\ninterface TemplatePreviewProps {\n  template: TicketTemplate;\n  isOpen: boolean;\n  onClose: () => void;\n  onUse: (template: TicketTemplate) => void;\n}\n\n// Default templates\nconst DEFAULT_TEMPLATES: TicketTemplate[] = [\n  {\n    id: '1',\n    name: 'Password Reset Request',\n    category: 'IT Support',\n    subject: 'Password Reset - {{ticketId}}',\n    content: `Hi {{customerName}},\\n\\nThank you for contacting IT Support regarding your password reset request.\\n\\nI have initiated the password reset process for your account. You should receive an email with reset instructions within the next 5-10 minutes.\\n\\nIf you don't receive the email, please check your spam folder or contact us again.\\n\\nPlease follow these steps:\\n1. Check your email for the password reset link\\n2. Click the link and follow the instructions\\n3. Create a strong password with at least 8 characters\\n4. Test your new password by logging in\\n\\nIf you continue to experience issues, please don't hesitate to reach out.\\n\\nBest regards,\\n{{agentName}}\\nIT Support Team`,\n    tags: ['password', 'reset', 'it-support', 'authentication'],\n    variables: ['customerName', 'ticketId', 'agentName'],\n    isPublic: true,\n    isFavorite: true,\n    usageCount: 47,\n    createdBy: 'admin',\n    createdAt: '2024-01-01T10:00:00Z',\n    updatedAt: '2024-01-05T14:30:00Z',\n  },\n  {\n    id: '2',\n    name: 'Software Installation Confirmation',\n    category: 'IT Support',\n    subject: 'Software Installation Complete - {{softwareName}}',\n    content: `Hi {{customerName}},\\n\\nThis is to confirm that the software installation for {{softwareName}} has been completed successfully on your system.\\n\\nInstallation Details:\\n- Software: {{softwareName}}\\n- Version: {{version}}\\n- Installation Date: {{currentDate}}\\n- License Type: {{licenseType}}\\n\\nNext Steps:\\n1. You can find the software in your applications menu\\n2. Please test the software to ensure it's working correctly\\n3. If you need training or have questions, please let us know\\n\\nIf you experience any issues or need assistance with the new software, please create a new ticket or reply to this one.\\n\\nBest regards,\\n{{agentName}}\\nIT Support Team`,\n    tags: ['software', 'installation', 'completion', 'it-support'],\n    variables: ['customerName', 'softwareName', 'version', 'currentDate', 'licenseType', 'agentName'],\n    isPublic: true,\n    isFavorite: false,\n    usageCount: 23,\n    createdBy: 'admin',\n    createdAt: '2024-01-02T09:15:00Z',\n    updatedAt: '2024-01-02T09:15:00Z',\n  },\n  {\n    id: '3',\n    name: 'Hardware Issue Investigation',\n    category: 'IT Support',\n    subject: 'Hardware Issue Investigation - {{ticketId}}',\n    content: `Hi {{customerName}},\\n\\nThank you for reporting the hardware issue with your {{deviceType}}.\\n\\nTo help us diagnose the problem, could you please provide the following information:\\n\\n1. Device Model: {{deviceModel}}\\n2. Serial Number: (if available)\\n3. Error Messages: (exact text if any)\\n4. When did the issue start?\\n5. Does the issue occur consistently or intermittently?\\n6. Any recent changes to your system?\\n\\nAdditional Steps:\\n- Please save any important work\\n- Try restarting your device if you haven't already\\n- Note any unusual sounds, lights, or behaviors\\n\\nOnce we receive this information, we'll schedule a time to either remotely diagnose the issue or arrange for on-site support.\\n\\nExpected Response Time: Within {{responseTime}} business hours\\n\\nBest regards,\\n{{agentName}}\\nIT Support Team`,\n    tags: ['hardware', 'investigation', 'troubleshooting', 'it-support'],\n    variables: ['customerName', 'deviceType', 'deviceModel', 'ticketId', 'responseTime', 'agentName'],\n    isPublic: true,\n    isFavorite: false,\n    usageCount: 31,\n    createdBy: 'admin',\n    createdAt: '2024-01-03T11:20:00Z',\n    updatedAt: '2024-01-06T16:45:00Z',\n  },\n];\n\nconst TEMPLATE_CATEGORIES = [\n  'All Categories',\n  'IT Support',\n  'HR',\n  'Finance',\n  'General',\n  'Facilities',\n  'Security',\n];\n\nconst COMMON_VARIABLES = [\n  'customerName',\n  'agentName',\n  'ticketId',\n  'currentDate',\n  'companyName',\n  'department',\n  'priority',\n  'category',\n];\n\nexport const TicketTemplates = React.memo<TicketTemplatesProps>(({ \n  onSelectTemplate, \n  className = '' \n}) => {\n  const [templates, setTemplates] = useState<TicketTemplate[]>(DEFAULT_TEMPLATES);\n  const [searchTerm, setSearchTerm] = useState('');\n  const [selectedCategory, setSelectedCategory] = useState('All Categories');\n  const [showFavoritesOnly, setShowFavoritesOnly] = useState(false);\n  const [isEditorOpen, setIsEditorOpen] = useState(false);\n  const [isPreviewOpen, setIsPreviewOpen] = useState(false);\n  const [selectedTemplate, setSelectedTemplate] = useState<TicketTemplate | null>(null);\n  const [editingTemplate, setEditingTemplate] = useState<TicketTemplate | undefined>();\n\n  // Filter templates based on search, category, and favorites\n  const filteredTemplates = useMemo(() => {\n    return templates.filter(template => {\n      const matchesSearch = template.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\n                          template.content.toLowerCase().includes(searchTerm.toLowerCase()) ||\n                          template.tags.some(tag => tag.toLowerCase().includes(searchTerm.toLowerCase()));\n      \n      const matchesCategory = selectedCategory === 'All Categories' || \n                            template.category === selectedCategory;\n      \n      const matchesFavorites = !showFavoritesOnly || template.isFavorite;\n      \n      return matchesSearch && matchesCategory && matchesFavorites;\n    });\n  }, [templates, searchTerm, selectedCategory, showFavoritesOnly]);\n\n  // Handle template actions\n  const handleNewTemplate = useCallback(() => {\n    setEditingTemplate(undefined);\n    setIsEditorOpen(true);\n  }, []);\n\n  const handleEditTemplate = useCallback((template: TicketTemplate) => {\n    setEditingTemplate(template);\n    setIsEditorOpen(true);\n  }, []);\n\n  const handlePreviewTemplate = useCallback((template: TicketTemplate) => {\n    setSelectedTemplate(template);\n    setIsPreviewOpen(true);\n  }, []);\n\n  const handleSaveTemplate = useCallback((templateData: Omit<TicketTemplate, 'id' | 'createdAt' | 'updatedAt' | 'usageCount'>) => {\n    const now = new Date().toISOString();\n    \n    if (editingTemplate) {\n      // Update existing template\n      setTemplates(prev => prev.map(t => \n        t.id === editingTemplate.id \n          ? { ...templateData, id: t.id, createdAt: t.createdAt, updatedAt: now, usageCount: t.usageCount }\n          : t\n      ));\n      toast.success('Template updated successfully');\n    } else {\n      // Create new template\n      const newTemplate: TicketTemplate = {\n        ...templateData,\n        id: Date.now().toString(),\n        createdAt: now,\n        updatedAt: now,\n        usageCount: 0,\n      };\n      setTemplates(prev => [newTemplate, ...prev]);\n      toast.success('Template created successfully');\n    }\n    \n    setIsEditorOpen(false);\n  }, [editingTemplate]);\n\n  const handleDeleteTemplate = useCallback((templateId: string) => {\n    setTemplates(prev => prev.filter(t => t.id !== templateId));\n    toast.success('Template deleted successfully');\n  }, []);\n\n  const handleToggleFavorite = useCallback((templateId: string) => {\n    setTemplates(prev => prev.map(t => \n      t.id === templateId ? { ...t, isFavorite: !t.isFavorite } : t\n    ));\n  }, []);\n\n  const handleUseTemplate = useCallback((template: TicketTemplate) => {\n    // Increment usage count\n    setTemplates(prev => prev.map(t => \n      t.id === template.id ? { ...t, usageCount: t.usageCount + 1 } : t\n    ));\n    \n    onSelectTemplate?.(template);\n    setIsPreviewOpen(false);\n    toast.success(`Template \"${template.name}\" applied`);\n  }, [onSelectTemplate]);\n\n  const handleDuplicateTemplate = useCallback((template: TicketTemplate) => {\n    const now = new Date().toISOString();\n    const duplicatedTemplate: TicketTemplate = {\n      ...template,\n      id: Date.now().toString(),\n      name: `${template.name} (Copy)`,\n      createdAt: now,\n      updatedAt: now,\n      usageCount: 0,\n      isFavorite: false,\n    };\n    \n    setTemplates(prev => [duplicatedTemplate, ...prev]);\n    toast.success('Template duplicated successfully');\n  }, []);\n\n  return (\n    <div className={`space-y-6 ${className}`}>\n      {/* Header */}\n      <div className=\"flex justify-between items-center\">\n        <div>\n          <h2 className=\"text-2xl font-bold tracking-tight\">Ticket Templates</h2>\n          <p className=\"text-muted-foreground\">\n            Manage and use pre-defined templates for faster ticket responses\n          </p>\n        </div>\n        \n        <Button onClick={handleNewTemplate} className=\"gap-1\">\n          <Plus className=\"w-4 h-4\" />\n          New Template\n        </Button>\n      </div>\n\n      {/* Filters */}\n      <Card>\n        <CardContent className=\"pt-6\">\n          <div className=\"flex flex-col md:flex-row gap-4\">\n            <div className=\"flex-1\">\n              <div className=\"relative\">\n                <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4\" />\n                <Input\n                  placeholder=\"Search templates, content, or tags...\"\n                  value={searchTerm}\n                  onChange={(e) => setSearchTerm(e.target.value)}\n                  className=\"pl-10\"\n                />\n              </div>\n            </div>\n            \n            <Select value={selectedCategory} onValueChange={setSelectedCategory}>\n              <SelectTrigger className=\"w-full md:w-[180px]\">\n                <SelectValue placeholder=\"Category\" />\n              </SelectTrigger>\n              <SelectContent>\n                {TEMPLATE_CATEGORIES.map(category => (\n                  <SelectItem key={category} value={category}>\n                    {category}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n            \n            <div className=\"flex items-center space-x-2\">\n              <Star className=\"w-4 h-4 text-yellow-500\" />\n              <Label htmlFor=\"favorites\" className=\"text-sm font-medium\">\n                Favorites only\n              </Label>\n              <Switch\n                id=\"favorites\"\n                checked={showFavoritesOnly}\n                onCheckedChange={setShowFavoritesOnly}\n              />\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Templates Grid */}\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-4\">\n        {filteredTemplates.length === 0 ? (\n          <div className=\"col-span-full text-center py-12\">\n            <FileText className=\"w-12 h-12 mx-auto mb-4 text-muted-foreground\" />\n            <h3 className=\"text-lg font-medium mb-2\">No templates found</h3>\n            <p className=\"text-muted-foreground mb-4\">\n              {searchTerm || selectedCategory !== 'All Categories' || showFavoritesOnly\n                ? 'Try adjusting your filters or search terms'\n                : 'Get started by creating your first template'\n              }\n            </p>\n            <Button onClick={handleNewTemplate} variant=\"outline\">\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Create Template\n            </Button>\n          </div>\n        ) : (\n          filteredTemplates.map(template => (\n            <Card key={template.id} className=\"hover:shadow-md transition-shadow\">\n              <CardHeader>\n                <div className=\"flex items-start justify-between\">\n                  <div className=\"space-y-1\">\n                    <CardTitle className=\"text-lg flex items-center gap-2\">\n                      {template.name}\n                      {template.isFavorite && (\n                        <Star className=\"w-4 h-4 text-yellow-500 fill-current\" />\n                      )}\n                    </CardTitle>\n                    <CardDescription>\n                      {template.category} â€¢ Used {template.usageCount} times\n                    </CardDescription>\n                  </div>\n                  \n                  <DropdownMenu>\n                    <DropdownMenuTrigger asChild>\n                      <Button variant=\"ghost\" size=\"sm\">\n                        <svg className=\"w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                          <path d=\"M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z\" />\n                        </svg>\n                      </Button>\n                    </DropdownMenuTrigger>\n                    <DropdownMenuContent align=\"end\">\n                      <DropdownMenuItem onClick={() => handlePreviewTemplate(template)}>\n                        <Eye className=\"w-4 h-4 mr-2\" />\n                        Preview & Use\n                      </DropdownMenuItem>\n                      <DropdownMenuItem onClick={() => handleEditTemplate(template)}>\n                        <Edit3 className=\"w-4 h-4 mr-2\" />\n                        Edit\n                      </DropdownMenuItem>\n                      <DropdownMenuItem onClick={() => handleDuplicateTemplate(template)}>\n                        <Copy className=\"w-4 h-4 mr-2\" />\n                        Duplicate\n                      </DropdownMenuItem>\n                      <DropdownMenuItem onClick={() => handleToggleFavorite(template.id)}>\n                        <Star className={`w-4 h-4 mr-2 ${template.isFavorite ? 'text-yellow-500' : ''}`} />\n                        {template.isFavorite ? 'Remove from Favorites' : 'Add to Favorites'}\n                      </DropdownMenuItem>\n                      <DropdownMenuSeparator />\n                      <DropdownMenuItem \n                        onClick={() => handleDeleteTemplate(template.id)}\n                        className=\"text-red-600 focus:text-red-600\"\n                      >\n                        <Trash2 className=\"w-4 h-4 mr-2\" />\n                        Delete\n                      </DropdownMenuItem>\n                    </DropdownMenuContent>\n                  </DropdownMenu>\n                </div>\n              </CardHeader>\n              \n              <CardContent className=\"space-y-4\">\n                <div>\n                  <p className=\"text-sm font-medium mb-1\">Subject Template:</p>\n                  <p className=\"text-sm text-muted-foreground bg-gray-50 dark:bg-gray-800 p-2 rounded\">\n                    {template.subject}\n                  </p>\n                </div>\n                \n                <div>\n                  <p className=\"text-sm font-medium mb-2\">Content Preview:</p>\n                  <div className=\"text-sm text-muted-foreground bg-gray-50 dark:bg-gray-800 p-3 rounded max-h-24 overflow-hidden relative\">\n                    {template.content.split('\\n').slice(0, 3).join(' ')}\n                    {template.content.split('\\n').length > 3 && (\n                      <div className=\"absolute bottom-0 left-0 right-0 h-6 bg-gradient-to-t from-gray-50 dark:from-gray-800 to-transparent\" />\n                    )}\n                  </div>\n                </div>\n                \n                {template.tags.length > 0 && (\n                  <div className=\"flex flex-wrap gap-1\">\n                    {template.tags.slice(0, 3).map(tag => (\n                      <Badge key={tag} variant=\"secondary\" className=\"text-xs\">\n                        {tag}\n                      </Badge>\n                    ))}\n                    {template.tags.length > 3 && (\n                      <Badge variant=\"outline\" className=\"text-xs\">\n                        +{template.tags.length - 3} more\n                      </Badge>\n                    )}\n                  </div>\n                )}\n                \n                <div className=\"flex gap-2\">\n                  <Button \n                    onClick={() => handlePreviewTemplate(template)}\n                    className=\"flex-1\"\n                    size=\"sm\"\n                  >\n                    <Eye className=\"w-4 h-4 mr-1\" />\n                    Use Template\n                  </Button>\n                  <Button \n                    onClick={() => handleEditTemplate(template)}\n                    variant=\"outline\"\n                    size=\"sm\"\n                  >\n                    <Edit3 className=\"w-4 h-4\" />\n                  </Button>\n                </div>\n              </CardContent>\n            </Card>\n          ))\n        )}\n      </div>\n\n      {/* Template Editor Dialog */}\n      <TemplateEditor\n        template={editingTemplate}\n        isOpen={isEditorOpen}\n        onClose={() => setIsEditorOpen(false)}\n        onSave={handleSaveTemplate}\n      />\n\n      {/* Template Preview Dialog */}\n      {selectedTemplate && (\n        <TemplatePreview\n          template={selectedTemplate}\n          isOpen={isPreviewOpen}\n          onClose={() => setIsPreviewOpen(false)}\n          onUse={handleUseTemplate}\n        />\n      )}\n    </div>\n  );\n});\n\nTicketTemplates.displayName = 'TicketTemplates';\n\n// Template Editor Component\nconst TemplateEditor: React.FC<TemplateEditorProps> = ({ \n  template, \n  isOpen, \n  onClose, \n  onSave \n}) => {\n  const [formData, setFormData] = useState({\n    name: '',\n    category: 'General',\n    subject: '',\n    content: '',\n    tags: [] as string[],\n    variables: [] as string[],\n    isPublic: true,\n    isFavorite: false,\n    createdBy: 'current-user', // Would come from auth context\n  });\n  \n  const [newTag, setNewTag] = useState('');\n  const [newVariable, setNewVariable] = useState('');\n\n  // Initialize form data when template changes\n  React.useEffect(() => {\n    if (template) {\n      setFormData({\n        name: template.name,\n        category: template.category,\n        subject: template.subject,\n        content: template.content,\n        tags: [...template.tags],\n        variables: [...template.variables],\n        isPublic: template.isPublic,\n        isFavorite: template.isFavorite,\n        createdBy: template.createdBy,\n      });\n    } else {\n      setFormData({\n        name: '',\n        category: 'General',\n        subject: '',\n        content: '',\n        tags: [],\n        variables: [],\n        isPublic: true,\n        isFavorite: false,\n        createdBy: 'current-user',\n      });\n    }\n  }, [template, isOpen]);\n\n  const handleSave = () => {\n    if (!formData.name.trim() || !formData.content.trim()) {\n      toast.error('Please fill in all required fields');\n      return;\n    }\n    \n    onSave(formData);\n  };\n\n  const handleAddTag = () => {\n    if (newTag.trim() && !formData.tags.includes(newTag.trim().toLowerCase())) {\n      setFormData(prev => ({ \n        ...prev, \n        tags: [...prev.tags, newTag.trim().toLowerCase()] \n      }));\n      setNewTag('');\n    }\n  };\n\n  const handleRemoveTag = (tag: string) => {\n    setFormData(prev => ({ \n      ...prev, \n      tags: prev.tags.filter(t => t !== tag) \n    }));\n  };\n\n  const handleAddVariable = () => {\n    if (newVariable.trim() && !formData.variables.includes(newVariable.trim())) {\n      setFormData(prev => ({ \n        ...prev, \n        variables: [...prev.variables, newVariable.trim()] \n      }));\n      setNewVariable('');\n    }\n  };\n\n  const handleRemoveVariable = (variable: string) => {\n    setFormData(prev => ({ \n      ...prev, \n      variables: prev.variables.filter(v => v !== variable) \n    }));\n  };\n\n  const addCommonVariable = (variable: string) => {\n    if (!formData.variables.includes(variable)) {\n      setFormData(prev => ({ \n        ...prev, \n        variables: [...prev.variables, variable] \n      }));\n    }\n  };\n\n  return (\n    <Dialog open={isOpen} onOpenChange={onClose}>\n      <DialogContent className=\"sm:max-w-[700px] max-h-[90vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle>\n            {template ? 'Edit Template' : 'Create New Template'}\n          </DialogTitle>\n          <DialogDescription>\n            Create reusable templates for faster ticket responses with dynamic variables\n          </DialogDescription>\n        </DialogHeader>\n        \n        <div className=\"space-y-6\">\n          {/* Basic Information */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"name\">Template Name *</Label>\n              <Input\n                id=\"name\"\n                value={formData.name}\n                onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                placeholder=\"e.g., Password Reset Response\"\n              />\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label htmlFor=\"category\">Category</Label>\n              <Select \n                value={formData.category} \n                onValueChange={(category) => setFormData({ ...formData, category })}\n              >\n                <SelectTrigger>\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {TEMPLATE_CATEGORIES.slice(1).map(category => (\n                    <SelectItem key={category} value={category}>\n                      {category}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n          \n          {/* Subject Template */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"subject\">Subject Template</Label>\n            <Input\n              id=\"subject\"\n              value={formData.subject}\n              onChange={(e) => setFormData({ ...formData, subject: e.target.value })}\n              placeholder=\"Use {{variables}} for dynamic content, e.g., Password Reset - {{ticketId}}\"\n            />\n          </div>\n          \n          {/* Content Template */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"content\">Content Template *</Label>\n            <Textarea\n              id=\"content\"\n              value={formData.content}\n              onChange={(e) => setFormData({ ...formData, content: e.target.value })}\n              rows={8}\n              placeholder=\"Enter your template content here...\\n\\nUse {{variables}} for dynamic content like {{customerName}}, {{agentName}}, etc.\"\n            />\n            <p className=\"text-xs text-muted-foreground\">\n              Use double curly braces for variables: {{'{'}}{'{'}variableName{'}'}{'}'}\n            </p>\n          </div>\n          \n          {/* Variables */}\n          <div className=\"space-y-3\">\n            <Label>Variables</Label>\n            <div className=\"space-y-2\">\n              <div className=\"flex gap-2\">\n                <Input\n                  value={newVariable}\n                  onChange={(e) => setNewVariable(e.target.value)}\n                  placeholder=\"Enter variable name (e.g., customerName)\"\n                  onKeyPress={(e) => e.key === 'Enter' && handleAddVariable()}\n                />\n                <Button onClick={handleAddVariable} size=\"sm\">\n                  Add\n                </Button>\n              </div>\n              \n              <div className=\"flex flex-wrap gap-1\">\n                <span className=\"text-sm text-muted-foreground mr-2\">Quick add:</span>\n                {COMMON_VARIABLES.filter(v => !formData.variables.includes(v)).map(variable => (\n                  <Button\n                    key={variable}\n                    variant=\"outline\"\n                    size=\"sm\"\n                    className=\"text-xs h-6\"\n                    onClick={() => addCommonVariable(variable)}\n                  >\n                    {variable}\n                  </Button>\n                ))}\n              </div>\n              \n              {formData.variables.length > 0 && (\n                <div className=\"flex flex-wrap gap-1\">\n                  {formData.variables.map(variable => (\n                    <Badge key={variable} className=\"gap-1\">\n                      {variable}\n                      <button\n                        onClick={() => handleRemoveVariable(variable)}\n                        className=\"ml-1 hover:bg-white/20 rounded\"\n                      >\n                        <X className=\"w-3 h-3\" />\n                      </button>\n                    </Badge>\n                  ))}\n                </div>\n              )}\n            </div>\n          </div>\n          \n          {/* Tags */}\n          <div className=\"space-y-3\">\n            <Label>Tags</Label>\n            <div className=\"space-y-2\">\n              <div className=\"flex gap-2\">\n                <Input\n                  value={newTag}\n                  onChange={(e) => setNewTag(e.target.value)}\n                  placeholder=\"Add tags for organization\"\n                  onKeyPress={(e) => e.key === 'Enter' && handleAddTag()}\n                />\n                <Button onClick={handleAddTag} size=\"sm\">\n                  Add\n                </Button>\n              </div>\n              \n              {formData.tags.length > 0 && (\n                <div className=\"flex flex-wrap gap-1\">\n                  {formData.tags.map(tag => (\n                    <Badge key={tag} variant=\"secondary\" className=\"gap-1\">\n                      {tag}\n                      <button\n                        onClick={() => handleRemoveTag(tag)}\n                        className=\"ml-1 hover:bg-white/20 rounded\"\n                      >\n                        <X className=\"w-3 h-3\" />\n                      </button>\n                    </Badge>\n                  ))}\n                </div>\n              )}\n            </div>\n          </div>\n          \n          {/* Settings */}\n          <div className=\"space-y-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <Label>Public Template</Label>\n                <p className=\"text-sm text-muted-foreground\">\n                  Allow other team members to use this template\n                </p>\n              </div>\n              <Switch\n                checked={formData.isPublic}\n                onCheckedChange={(isPublic) => setFormData({ ...formData, isPublic })}\n              />\n            </div>\n            \n            <div className=\"flex items-center justify-between\">\n              <div>\n                <Label>Add to Favorites</Label>\n                <p className=\"text-sm text-muted-foreground\">\n                  Mark this template as a favorite for quick access\n                </p>\n              </div>\n              <Switch\n                checked={formData.isFavorite}\n                onCheckedChange={(isFavorite) => setFormData({ ...formData, isFavorite })}\n              />\n            </div>\n          </div>\n        </div>\n        \n        <DialogFooter>\n          <Button variant=\"outline\" onClick={onClose}>\n            Cancel\n          </Button>\n          <Button onClick={handleSave}>\n            <Save className=\"w-4 h-4 mr-2\" />\n            {template ? 'Update Template' : 'Create Template'}\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n};\n\n// Template Preview Component\nconst TemplatePreview: React.FC<TemplatePreviewProps> = ({ \n  template, \n  isOpen, \n  onClose, \n  onUse \n}) => {\n  const [variableValues, setVariableValues] = useState<Record<string, string>>({});\n  \n  // Initialize variable values\n  React.useEffect(() => {\n    if (isOpen) {\n      const initialValues: Record<string, string> = {};\n      template.variables.forEach(variable => {\n        // Set default values for common variables\n        switch (variable) {\n          case 'currentDate':\n            initialValues[variable] = new Date().toLocaleDateString();\n            break;\n          case 'agentName':\n            initialValues[variable] = 'Your Name'; // Would come from auth context\n            break;\n          case 'companyName':\n            initialValues[variable] = 'Your Company';\n            break;\n          default:\n            initialValues[variable] = `{{${variable}}}`;\n        }\n      });\n      setVariableValues(initialValues);\n    }\n  }, [template.variables, isOpen]);\n  \n  // Replace variables in content\n  const processedSubject = useMemo(() => {\n    let result = template.subject;\n    Object.entries(variableValues).forEach(([variable, value]) => {\n      result = result.replace(new RegExp(`\\{\\{${variable}\\}\\}`, 'g'), value);\n    });\n    return result;\n  }, [template.subject, variableValues]);\n  \n  const processedContent = useMemo(() => {\n    let result = template.content;\n    Object.entries(variableValues).forEach(([variable, value]) => {\n      result = result.replace(new RegExp(`\\{\\{${variable}\\}\\}`, 'g'), value);\n    });\n    return result;\n  }, [template.content, variableValues]);\n\n  return (\n    <Dialog open={isOpen} onOpenChange={onClose}>\n      <DialogContent className=\"sm:max-w-[800px] max-h-[90vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            <FileText className=\"w-5 h-5\" />\n            Preview Template: {template.name}\n          </DialogTitle>\n          <DialogDescription>\n            Preview and customize variables before using this template\n          </DialogDescription>\n        </DialogHeader>\n        \n        <div className=\"space-y-6\">\n          {/* Template Info */}\n          <div className=\"bg-gray-50 dark:bg-gray-800 rounded-lg p-4\">\n            <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm\">\n              <div>\n                <span className=\"text-muted-foreground\">Category:</span>\n                <div className=\"font-medium\">{template.category}</div>\n              </div>\n              <div>\n                <span className=\"text-muted-foreground\">Used:</span>\n                <div className=\"font-medium\">{template.usageCount} times</div>\n              </div>\n              <div>\n                <span className=\"text-muted-foreground\">Created:</span>\n                <div className=\"font-medium\">\n                  {new Date(template.createdAt).toLocaleDateString()}\n                </div>\n              </div>\n              <div>\n                <span className=\"text-muted-foreground\">Variables:</span>\n                <div className=\"font-medium\">{template.variables.length}</div>\n              </div>\n            </div>\n          </div>\n          \n          {/* Variable Inputs */}\n          {template.variables.length > 0 && (\n            <div className=\"space-y-3\">\n              <h4 className=\"font-medium\">Customize Variables</h4>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {template.variables.map(variable => (\n                  <div key={variable} className=\"space-y-1\">\n                    <Label htmlFor={variable}>{variable}</Label>\n                    <Input\n                      id={variable}\n                      value={variableValues[variable] || ''}\n                      onChange={(e) => setVariableValues(prev => ({\n                        ...prev,\n                        [variable]: e.target.value\n                      }))}\n                      placeholder={`Enter ${variable}`}\n                    />\n                  </div>\n                ))}\n              </div>\n            </div>\n          )}\n          \n          {/* Preview */}\n          <div className=\"space-y-4\">\n            <h4 className=\"font-medium\">Template Preview</h4>\n            \n            <div className=\"space-y-3\">\n              <div>\n                <Label className=\"text-sm font-medium\">Subject:</Label>\n                <div className=\"mt-1 p-3 bg-blue-50 dark:bg-blue-950/20 rounded border\">\n                  {processedSubject}\n                </div>\n              </div>\n              \n              <div>\n                <Label className=\"text-sm font-medium\">Content:</Label>\n                <div className=\"mt-1 p-4 bg-gray-50 dark:bg-gray-800 rounded border whitespace-pre-wrap\">\n                  {processedContent}\n                </div>\n              </div>\n            </div>\n          </div>\n          \n          {/* Tags */}\n          {template.tags.length > 0 && (\n            <div>\n              <Label className=\"text-sm font-medium\">Tags:</Label>\n              <div className=\"mt-1 flex flex-wrap gap-1\">\n                {template.tags.map(tag => (\n                  <Badge key={tag} variant=\"secondary\">{tag}</Badge>\n                ))}\n              </div>\n            </div>\n          )}\n        </div>\n        \n        <DialogFooter>\n          <Button variant=\"outline\" onClick={onClose}>\n            Cancel\n          </Button>\n          <Button onClick={() => onUse(template)}>\n            Use This Template\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nexport default TicketTemplates;"