import React, { useState, useCallback, useMemo } from 'react';\nimport { \n  Check, \n  Download, \n  Edit3, \n  Mail, \n  MoreHorizontal, \n  Trash2, \n  User, \n  CheckSquare,\n  Square,\n  Minus\n} from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { Checkbox } from '@/components/ui/checkbox';\nimport { \n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger \n} from '@/components/ui/dropdown-menu';\nimport { \n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue \n} from '@/components/ui/select';\nimport { \n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle \n} from '@/components/ui/dialog';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Label } from '@/components/ui/label';\nimport { Badge } from '@/components/ui/badge';\nimport { toast } from 'sonner';\nimport type { HelpdeskTicket } from '@/types/helpdesk';\nimport { useHelpdeskStoreEnhanced } from '@/store/helpdeskStoreEnhanced';\n\ninterface BulkOperationsProps {\n  tickets: HelpdeskTicket[];\n  selectedTickets: string[];\n  onSelectionChange: (ticketIds: string[]) => void;\n  className?: string;\n}\n\ninterface BulkActionDialogProps {\n  open: boolean;\n  onClose: () => void;\n  action: BulkAction;\n  selectedTickets: HelpdeskTicket[];\n  onConfirm: (data: any) => Promise<void>;\n}\n\ntype BulkAction = \n  | 'status_update'\n  | 'assign'\n  | 'priority_update'\n  | 'delete'\n  | 'export'\n  | 'send_notification';\n\nconst STATUS_OPTIONS = [\n  { value: 'Open', label: 'Open' },\n  { value: 'In Progress', label: 'In Progress' },\n  { value: 'Resolved', label: 'Resolved' },\n  { value: 'Closed', label: 'Closed' },\n  { value: 'Cancelled', label: 'Cancelled' },\n];\n\nconst PRIORITY_OPTIONS = [\n  { value: 'Low', label: 'Low' },\n  { value: 'Medium', label: 'Medium' },\n  { value: 'High', label: 'High' },\n  { value: 'Critical', label: 'Critical' },\n];\n\nconst ASSIGNEES = [\n  { value: 'john.doe', label: 'John Doe' },\n  { value: 'jane.smith', label: 'Jane Smith' },\n  { value: 'mike.wilson', label: 'Mike Wilson' },\n  { value: 'sarah.jones', label: 'Sarah Jones' },\n];\n\nexport const BulkOperations = React.memo<BulkOperationsProps>(({ \n  tickets, \n  selectedTickets, \n  onSelectionChange, \n  className = '' \n}) => {\n  const [currentAction, setCurrentAction] = useState<BulkAction | null>(null);\n  const [dialogOpen, setDialogOpen] = useState(false);\n  \n  const { bulkUpdateStatus, bulkAssignTickets } = useHelpdeskStoreEnhanced();\n\n  // Selection state management\n  const isAllSelected = useMemo(() => {\n    return tickets.length > 0 && selectedTickets.length === tickets.length;\n  }, [tickets.length, selectedTickets.length]);\n\n  const isPartiallySelected = useMemo(() => {\n    return selectedTickets.length > 0 && selectedTickets.length < tickets.length;\n  }, [selectedTickets.length, tickets.length]);\n\n  const selectedTicketObjects = useMemo(() => {\n    return tickets.filter(ticket => \n      selectedTickets.includes(ticket.id || ticket._id || '')\n    );\n  }, [tickets, selectedTickets]);\n\n  // Selection handlers\n  const handleSelectAll = useCallback(() => {\n    if (isAllSelected) {\n      onSelectionChange([]);\n    } else {\n      const allIds = tickets.map(t => t.id || t._id || '').filter(Boolean);\n      onSelectionChange(allIds);\n    }\n  }, [isAllSelected, tickets, onSelectionChange]);\n\n  const handleTicketSelect = useCallback((ticketId: string) => {\n    if (selectedTickets.includes(ticketId)) {\n      onSelectionChange(selectedTickets.filter(id => id !== ticketId));\n    } else {\n      onSelectionChange([...selectedTickets, ticketId]);\n    }\n  }, [selectedTickets, onSelectionChange]);\n\n  // Action handlers\n  const handleBulkAction = useCallback((action: BulkAction) => {\n    setCurrentAction(action);\n    setDialogOpen(true);\n  }, []);\n\n  const handleActionConfirm = useCallback(async (data: any) => {\n    if (!currentAction) return;\n\n    try {\n      switch (currentAction) {\n        case 'status_update':\n          await bulkUpdateStatus(selectedTickets, data.status);\n          break;\n        case 'assign':\n          await bulkAssignTickets(selectedTickets, data.assigneeId, data.assigneeName);\n          break;\n        case 'priority_update':\n          // Would need to implement in store\n          toast.info('Priority update not yet implemented');\n          break;\n        case 'delete':\n          // Would need to implement bulk delete\n          toast.info('Bulk delete not yet implemented');\n          break;\n        case 'export':\n          handleExport();\n          break;\n        case 'send_notification':\n          // Would integrate with notification system\n          toast.success(`Notification sent to ${selectedTickets.length} ticket holders`);\n          break;\n      }\n      \n      setDialogOpen(false);\n      onSelectionChange([]); // Clear selection after action\n    } catch (error) {\n      toast.error(`Failed to execute bulk action: ${error}`);\n    }\n  }, [currentAction, selectedTickets, bulkUpdateStatus, bulkAssignTickets, onSelectionChange]);\n\n  // Export functionality\n  const handleExport = useCallback(() => {\n    const csvHeaders = [\n      'Ticket ID',\n      'Subject',\n      'Status',\n      'Priority',\n      'Created Date',\n      'User',\n      'Assigned To',\n      'Description'\n    ];\n\n    const csvData = selectedTicketObjects.map(ticket => [\n      ticket.id || ticket._id || '',\n      ticket.subject,\n      ticket.status,\n      ticket.urgency,\n      ticket.createdAt,\n      ticket.userName,\n      ticket.assignedTo || 'Unassigned',\n      `\"${ticket.description.replace(/\"/g, '\"\"')}\"`\n    ]);\n\n    const csvContent = [\n      csvHeaders.join(','),\n      ...csvData.map(row => row.join(','))\n    ].join('\\n');\n\n    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });\n    const link = document.createElement('a');\n    const url = URL.createObjectURL(blob);\n    link.setAttribute('href', url);\n    link.setAttribute('download', `helpdesk-tickets-${new Date().toISOString().split('T')[0]}.csv`);\n    link.style.visibility = 'hidden';\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n    \n    toast.success(`Exported ${selectedTickets.length} tickets to CSV`);\n    setDialogOpen(false);\n  }, [selectedTicketObjects, selectedTickets.length]);\n\n  // Clear selection\n  const handleClearSelection = useCallback(() => {\n    onSelectionChange([]);\n  }, [onSelectionChange]);\n\n  if (tickets.length === 0) {\n    return null;\n  }\n\n  return (\n    <>\n      <div className={`bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4 ${className}`}>\n        <div className=\"flex items-center justify-between gap-4\">\n          {/* Selection Controls */}\n          <div className=\"flex items-center gap-3\">\n            <div className=\"flex items-center space-x-2\">\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={handleSelectAll}\n                className=\"p-1 h-8 w-8\"\n              >\n                {isAllSelected ? (\n                  <CheckSquare className=\"h-4 w-4\" />\n                ) : isPartiallySelected ? (\n                  <Minus className=\"h-4 w-4\" />\n                ) : (\n                  <Square className=\"h-4 w-4\" />\n                )}\n              </Button>\n              \n              <span className=\"text-sm font-medium text-gray-900 dark:text-gray-100\">\n                {selectedTickets.length === 0 ? (\n                  'Select tickets'\n                ) : (\n                  `${selectedTickets.length} of ${tickets.length} selected`\n                )}\n              </span>\n            </div>\n\n            {selectedTickets.length > 0 && (\n              <div className=\"flex items-center gap-2\">\n                <Badge variant=\"secondary\" className=\"text-xs\">\n                  {selectedTickets.length} selected\n                </Badge>\n                \n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={handleClearSelection}\n                  className=\"text-red-600 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-950/20\"\n                >\n                  Clear\n                </Button>\n              </div>\n            )}\n          </div>\n\n          {/* Bulk Actions */}\n          {selectedTickets.length > 0 && (\n            <div className=\"flex items-center gap-2\">\n              {/* Quick Actions */}\n              <Button\n                size=\"sm\"\n                variant=\"outline\"\n                onClick={() => handleBulkAction('status_update')}\n                className=\"gap-1\"\n              >\n                <Edit3 className=\"w-4 h-4\" />\n                Update Status\n              </Button>\n              \n              <Button\n                size=\"sm\"\n                variant=\"outline\"\n                onClick={() => handleBulkAction('assign')}\n                className=\"gap-1\"\n              >\n                <User className=\"w-4 h-4\" />\n                Assign\n              </Button>\n              \n              <Button\n                size=\"sm\"\n                variant=\"outline\"\n                onClick={() => handleBulkAction('export')}\n                className=\"gap-1\"\n              >\n                <Download className=\"w-4 h-4\" />\n                Export\n              </Button>\n\n              {/* More Actions Dropdown */}\n              <DropdownMenu>\n                <DropdownMenuTrigger asChild>\n                  <Button size=\"sm\" variant=\"outline\">\n                    <MoreHorizontal className=\"w-4 h-4\" />\n                  </Button>\n                </DropdownMenuTrigger>\n                <DropdownMenuContent align=\"end\">\n                  <DropdownMenuItem onClick={() => handleBulkAction('priority_update')}>\n                    <Edit3 className=\"w-4 h-4 mr-2\" />\n                    Update Priority\n                  </DropdownMenuItem>\n                  \n                  <DropdownMenuItem onClick={() => handleBulkAction('send_notification')}>\n                    <Mail className=\"w-4 h-4 mr-2\" />\n                    Send Notification\n                  </DropdownMenuItem>\n                  \n                  <DropdownMenuSeparator />\n                  \n                  <DropdownMenuItem \n                    onClick={() => handleBulkAction('delete')}\n                    className=\"text-red-600 focus:text-red-600\"\n                  >\n                    <Trash2 className=\"w-4 h-4 mr-2\" />\n                    Delete Tickets\n                  </DropdownMenuItem>\n                </DropdownMenuContent>\n              </DropdownMenu>\n            </div>\n          )}\n        </div>\n      </div>\n\n      {/* Ticket Selection Checkboxes (to be used in ticket list) */}\n      <div className=\"hidden\">\n        {tickets.map(ticket => {\n          const ticketId = ticket.id || ticket._id || '';\n          return (\n            <Checkbox\n              key={ticketId}\n              checked={selectedTickets.includes(ticketId)}\n              onCheckedChange={() => handleTicketSelect(ticketId)}\n            />\n          );\n        })}\n      </div>\n\n      {/* Bulk Action Dialog */}\n      <BulkActionDialog\n        open={dialogOpen}\n        onClose={() => setDialogOpen(false)}\n        action={currentAction!}\n        selectedTickets={selectedTicketObjects}\n        onConfirm={handleActionConfirm}\n      />\n    </>\n  );\n});\n\nBulkOperations.displayName = 'BulkOperations';\n\n// Bulk Action Dialog Component\nconst BulkActionDialog: React.FC<BulkActionDialogProps> = ({ \n  open, \n  onClose, \n  action, \n  selectedTickets, \n  onConfirm \n}) => {\n  const [formData, setFormData] = useState<any>({});\n  const [isLoading, setIsLoading] = useState(false);\n\n  const handleConfirm = async () => {\n    setIsLoading(true);\n    try {\n      await onConfirm(formData);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const getDialogContent = () => {\n    switch (action) {\n      case 'status_update':\n        return {\n          title: 'Update Status',\n          description: `Update the status for ${selectedTickets.length} selected tickets`,\n          content: (\n            <div className=\"space-y-4\">\n              <div>\n                <Label htmlFor=\"status\">New Status</Label>\n                <Select\n                  value={formData.status || ''}\n                  onValueChange={(value) => setFormData({ ...formData, status: value })}\n                >\n                  <SelectTrigger>\n                    <SelectValue placeholder=\"Select status\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {STATUS_OPTIONS.map(option => (\n                      <SelectItem key={option.value} value={option.value}>\n                        {option.label}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              \n              <div>\n                <Label htmlFor=\"notes\">Notes (Optional)</Label>\n                <Textarea\n                  id=\"notes\"\n                  placeholder=\"Add notes for this status update...\"\n                  value={formData.notes || ''}\n                  onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\n                />\n              </div>\n            </div>\n          )\n        };\n\n      case 'assign':\n        return {\n          title: 'Assign Tickets',\n          description: `Assign ${selectedTickets.length} tickets to a team member`,\n          content: (\n            <div className=\"space-y-4\">\n              <div>\n                <Label htmlFor=\"assignee\">Assign To</Label>\n                <Select\n                  value={formData.assigneeId || ''}\n                  onValueChange={(value) => {\n                    const assignee = ASSIGNEES.find(a => a.value === value);\n                    setFormData({ \n                      ...formData, \n                      assigneeId: value,\n                      assigneeName: assignee?.label \n                    });\n                  }}\n                >\n                  <SelectTrigger>\n                    <SelectValue placeholder=\"Select team member\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {ASSIGNEES.map(assignee => (\n                      <SelectItem key={assignee.value} value={assignee.value}>\n                        {assignee.label}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              \n              <div>\n                <Label htmlFor=\"message\">Message to Assignee (Optional)</Label>\n                <Textarea\n                  id=\"message\"\n                  placeholder=\"Add a message for the assignee...\"\n                  value={formData.message || ''}\n                  onChange={(e) => setFormData({ ...formData, message: e.target.value })}\n                />\n              </div>\n            </div>\n          )\n        };\n\n      case 'delete':\n        return {\n          title: 'Delete Tickets',\n          description: `Are you sure you want to delete ${selectedTickets.length} tickets? This action cannot be undone.`,\n          content: (\n            <div className=\"space-y-4\">\n              <div className=\"p-4 bg-red-50 dark:bg-red-950/20 rounded-lg\">\n                <p className=\"text-sm text-red-800 dark:text-red-300\">\n                  ⚠️ This will permanently delete all selected tickets and their associated data.\n                </p>\n              </div>\n              \n              <div>\n                <Label htmlFor=\"reason\">Reason for Deletion</Label>\n                <Textarea\n                  id=\"reason\"\n                  placeholder=\"Please provide a reason for deleting these tickets...\"\n                  value={formData.reason || ''}\n                  onChange={(e) => setFormData({ ...formData, reason: e.target.value })}\n                  required\n                />\n              </div>\n            </div>\n          )\n        };\n\n      default:\n        return {\n          title: 'Bulk Action',\n          description: `Perform action on ${selectedTickets.length} selected tickets`,\n          content: <div>Action not implemented</div>\n        };\n    }\n  };\n\n  const { title, description, content } = getDialogContent();\n  const canConfirm = action === 'export' || \n    (action === 'status_update' && formData.status) ||\n    (action === 'assign' && formData.assigneeId) ||\n    (action === 'delete' && formData.reason?.trim());\n\n  return (\n    <Dialog open={open} onOpenChange={onClose}>\n      <DialogContent className=\"sm:max-w-[525px]\">\n        <DialogHeader>\n          <DialogTitle>{title}</DialogTitle>\n          <DialogDescription>{description}</DialogDescription>\n        </DialogHeader>\n        \n        {content}\n        \n        <DialogFooter>\n          <Button variant=\"outline\" onClick={onClose} disabled={isLoading}>\n            Cancel\n          </Button>\n          <Button \n            onClick={handleConfirm} \n            disabled={!canConfirm || isLoading}\n            className={action === 'delete' ? 'bg-red-600 hover:bg-red-700' : ''}\n          >\n            {isLoading ? 'Processing...' : action === 'delete' ? 'Delete' : 'Confirm'}\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n};\n\n// Utility component for individual ticket checkbox\nexport const TicketSelectionCheckbox: React.FC<{\n  ticket: HelpdeskTicket;\n  isSelected: boolean;\n  onToggle: (ticketId: string) => void;\n}> = ({ ticket, isSelected, onToggle }) => {\n  const ticketId = ticket.id || ticket._id || '';\n  \n  return (\n    <Checkbox\n      checked={isSelected}\n      onCheckedChange={() => onToggle(ticketId)}\n      className=\"mr-2\"\n    />\n  );\n};"