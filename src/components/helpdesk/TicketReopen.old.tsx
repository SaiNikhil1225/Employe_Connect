import React, { useState, useCallback, useMemo } from 'react';\nimport {\n  RotateCcw,\n  Clock,\n  AlertCircle,\n  CheckCircle,\n  FileText,\n  User,\n  Calendar\n} from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger\n} from '@/components/ui/dialog';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Label } from '@/components/ui/label';\nimport { toast } from 'sonner';\nimport { format, differenceInDays, isAfter, subDays } from 'date-fns';\nimport type { HelpdeskTicket } from '@/types/helpdesk';\nimport { useHelpdeskStoreEnhanced } from '@/store/helpdeskStoreEnhanced';\n\ninterface TicketReopenProps {\n  ticket: HelpdeskTicket;\n  onReopen?: () => void;\n  className?: string;\n}\n\ninterface ReopenDialogProps {\n  ticket: HelpdeskTicket;\n  isOpen: boolean;\n  onClose: () => void;\n  onConfirm: (reason: string) => Promise<void>;\n}\n\n// Configuration for reopen window (in days)\nconst REOPEN_WINDOW_DAYS = 7;\n\nexport const TicketReopen = React.memo<TicketReopenProps>(({ \n  ticket, \n  onReopen, \n  className = '' \n}) => {\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [isReopening, setIsReopening] = useState(false);\n  \n  const { updateTicket } = useHelpdeskStoreEnhanced();\n\n  // Check if ticket can be reopened\n  const canReopen = useMemo(() => {\n    // Only closed or resolved tickets can be reopened\n    const isClosedOrResolved = ticket.status === 'Closed' || ticket.status === 'Resolved';\n    \n    if (!isClosedOrResolved) return false;\n\n    // Check if within reopen window\n    const lastUpdated = new Date(ticket.updatedAt || ticket.createdAt);\n    const cutoffDate = subDays(new Date(), REOPEN_WINDOW_DAYS);\n    \n    return isAfter(lastUpdated, cutoffDate);\n  }, [ticket.status, ticket.updatedAt, ticket.createdAt]);\n\n  // Calculate days remaining for reopen\n  const daysRemaining = useMemo(() => {\n    if (!canReopen) return 0;\n    \n    const lastUpdated = new Date(ticket.updatedAt || ticket.createdAt);\n    const cutoffDate = subDays(new Date(), REOPEN_WINDOW_DAYS);\n    const remaining = REOPEN_WINDOW_DAYS - differenceInDays(new Date(), lastUpdated);\n    \n    return Math.max(0, remaining);\n  }, [canReopen, ticket.updatedAt, ticket.createdAt]);\n\n  // Handle reopen confirmation\n  const handleReopen = useCallback(async (reason: string) => {\n    setIsReopening(true);\n    try {\n      await updateTicket(ticket.id || ticket._id || '', {\n        status: 'Open',\n        reopenedAt: new Date().toISOString(),\n        reopenReason: reason,\n        updatedAt: new Date().toISOString(),\n      });\n      \n      toast.success('Ticket reopened successfully');\n      setIsDialogOpen(false);\n      onReopen?.();\n    } catch (error) {\n      toast.error('Failed to reopen ticket');\n    } finally {\n      setIsReopening(false);\n    }\n  }, [ticket, updateTicket, onReopen]);\n\n  if (!canReopen) {\n    return null;\n  }\n\n  return (\n    <div className={className}>\n      {/* Reopen Button */}\n      <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n        <DialogTrigger asChild>\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            className=\"gap-1 text-blue-600 hover:text-blue-700 border-blue-200 hover:border-blue-300\"\n            disabled={isReopening}\n          >\n            <RotateCcw className=\"w-4 h-4\" />\n            Reopen Ticket\n          </Button>\n        </DialogTrigger>\n        \n        <ReopenDialog\n          ticket={ticket}\n          isOpen={isDialogOpen}\n          onClose={() => setIsDialogOpen(false)}\n          onConfirm={handleReopen}\n        />\n      </Dialog>\n\n      {/* Reopen Window Indicator */}\n      <div className=\"mt-2 flex items-center gap-2 text-sm text-muted-foreground\">\n        <Clock className=\"w-4 h-4\" />\n        <span>\n          Can reopen for {daysRemaining} more day{daysRemaining !== 1 ? 's' : ''}\n        </span>\n        {daysRemaining <= 2 && (\n          <Badge variant=\"secondary\" className=\"text-xs bg-yellow-100 text-yellow-800\">\n            Expires soon\n          </Badge>\n        )}\n      </div>\n    </div>\n  );\n});\n\nTicketReopen.displayName = 'TicketReopen';\n\n// Reopen Dialog Component\nconst ReopenDialog: React.FC<ReopenDialogProps> = ({ \n  ticket, \n  isOpen, \n  onClose, \n  onConfirm \n}) => {\n  const [reason, setReason] = useState('');\n  const [isSubmitting, setIsSubmitting] = useState(false);\n\n  const handleSubmit = async () => {\n    if (!reason.trim()) {\n      toast.error('Please provide a reason for reopening this ticket');\n      return;\n    }\n\n    setIsSubmitting(true);\n    try {\n      await onConfirm(reason.trim());\n    } finally {\n      setIsSubmitting(false);\n    }\n  };\n\n  const handleClose = () => {\n    setReason('');\n    onClose();\n  };\n\n  return (\n    <DialogContent className=\"sm:max-w-[525px]\">\n      <DialogHeader>\n        <DialogTitle className=\"flex items-center gap-2\">\n          <RotateCcw className=\"w-5 h-5 text-blue-600\" />\n          Reopen Ticket\n        </DialogTitle>\n        <DialogDescription>\n          You are about to reopen this ticket. Please provide a reason for the action.\n        </DialogDescription>\n      </DialogHeader>\n      \n      {/* Ticket Information */}\n      <div className=\"space-y-4\">\n        <div className=\"bg-gray-50 dark:bg-gray-800 rounded-lg p-4 space-y-3\">\n          <div className=\"flex items-center justify-between\">\n            <h4 className=\"font-medium text-sm\">Ticket Details</h4>\n            <Badge variant=\"outline\">\n              {ticket.id || ticket._id}\n            </Badge>\n          </div>\n          \n          <div className=\"grid grid-cols-2 gap-4 text-sm\">\n            <div className=\"flex items-center gap-2\">\n              <FileText className=\"w-4 h-4 text-muted-foreground\" />\n              <span className=\"text-muted-foreground\">Subject:</span>\n            </div>\n            <div className=\"font-medium truncate\">\n              {ticket.subject}\n            </div>\n            \n            <div className=\"flex items-center gap-2\">\n              <User className=\"w-4 h-4 text-muted-foreground\" />\n              <span className=\"text-muted-foreground\">Customer:</span>\n            </div>\n            <div className=\"font-medium\">\n              {ticket.userName}\n            </div>\n            \n            <div className=\"flex items-center gap-2\">\n              <Calendar className=\"w-4 h-4 text-muted-foreground\" />\n              <span className=\"text-muted-foreground\">Closed:</span>\n            </div>\n            <div className=\"font-medium\">\n              {format(new Date(ticket.updatedAt || ticket.createdAt), 'MMM dd, yyyy')}\n            </div>\n          </div>\n        </div>\n\n        {/* Reason Input */}\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"reason\" className=\"text-sm font-medium\">\n            Reason for Reopening *\n          </Label>\n          <Textarea\n            id=\"reason\"\n            placeholder=\"Please explain why this ticket needs to be reopened...\"\n            value={reason}\n            onChange={(e) => setReason(e.target.value)}\n            rows={4}\n            className=\"resize-none\"\n          />\n          <p className=\"text-xs text-muted-foreground\">\n            This reason will be logged in the ticket history for audit purposes.\n          </p>\n        </div>\n\n        {/* Warning Notice */}\n        <div className=\"flex items-start gap-3 p-3 bg-blue-50 dark:bg-blue-950/20 rounded-lg\">\n          <AlertCircle className=\"w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0\" />\n          <div className=\"space-y-1\">\n            <h5 className=\"text-sm font-medium text-blue-900 dark:text-blue-300\">\n              Ticket Reopen Policy\n            </h5>\n            <p className=\"text-xs text-blue-700 dark:text-blue-400\">\n              Reopened tickets will reset their SLA timers and require fresh assignment. \n              The customer will be automatically notified of the status change.\n            </p>\n          </div>\n        </div>\n      </div>\n      \n      <DialogFooter className=\"gap-2\">\n        <Button \n          variant=\"outline\" \n          onClick={handleClose} \n          disabled={isSubmitting}\n        >\n          Cancel\n        </Button>\n        <Button \n          onClick={handleSubmit} \n          disabled={!reason.trim() || isSubmitting}\n          className=\"bg-blue-600 hover:bg-blue-700\"\n        >\n          {isSubmitting ? (\n            <>\n              <RotateCcw className=\"w-4 h-4 mr-2 animate-spin\" />\n              Reopening...\n            </>\n          ) : (\n            <>\n              <RotateCcw className=\"w-4 h-4 mr-2\" />\n              Reopen Ticket\n            </>\n          )}\n        </Button>\n      </DialogFooter>\n    </DialogContent>\n  );\n};\n\n// Hook for ticket reopen functionality\nexport const useTicketReopen = () => {\n  const { updateTicket } = useHelpdeskStoreEnhanced();\n\n  const canTicketBeReopened = useCallback((ticket: HelpdeskTicket) => {\n    const isClosedOrResolved = ticket.status === 'Closed' || ticket.status === 'Resolved';\n    \n    if (!isClosedOrResolved) return false;\n\n    const lastUpdated = new Date(ticket.updatedAt || ticket.createdAt);\n    const cutoffDate = subDays(new Date(), REOPEN_WINDOW_DAYS);\n    \n    return isAfter(lastUpdated, cutoffDate);\n  }, []);\n\n  const reopenTicket = useCallback(async (\n    ticketId: string, \n    reason: string,\n    additionalData?: Partial<HelpdeskTicket>\n  ) => {\n    try {\n      await updateTicket(ticketId, {\n        status: 'Open',\n        reopenedAt: new Date().toISOString(),\n        reopenReason: reason,\n        updatedAt: new Date().toISOString(),\n        ...additionalData,\n      });\n      \n      return { success: true };\n    } catch (error) {\n      return { \n        success: false, \n        error: error instanceof Error ? error.message : 'Failed to reopen ticket' \n      };\n    }\n  }, [updateTicket]);\n\n  return {\n    canTicketBeReopened,\n    reopenTicket,\n    REOPEN_WINDOW_DAYS,\n  };\n};\n\nexport default TicketReopen;"