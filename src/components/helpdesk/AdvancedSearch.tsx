import React, { useState, useCallback, useMemo } from 'react';\nimport { Search, Filter, X, Calendar, User, Tag, SlidersHorizontal } from 'lucide-react';\nimport { Input } from '@/components/ui/input';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport { Calendar as CalendarComponent } from '@/components/ui/calendar';\nimport { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Checkbox } from '@/components/ui/checkbox';\nimport { Label } from '@/components/ui/label';\nimport { Separator } from '@/components/ui/separator';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { format } from 'date-fns';\nimport type { HelpdeskTicket } from '@/types/helpdesk';\n\nexport interface SearchFilters {\n  searchText?: string;\n  status?: string[];\n  priority?: string[];\n  assignee?: string[];\n  category?: string[];\n  dateRange?: {\n    start: Date;\n    end: Date;\n  };\n}\n\ninterface AdvancedSearchProps {\n  onFiltersChange: (filters: SearchFilters) => void;\n  tickets: HelpdeskTicket[];\n  className?: string;\n}\n\nconst STATUS_OPTIONS = [\n  { value: 'Open', label: 'Open', color: 'bg-blue-100 text-blue-800' },\n  { value: 'In Progress', label: 'In Progress', color: 'bg-yellow-100 text-yellow-800' },\n  { value: 'Resolved', label: 'Resolved', color: 'bg-green-100 text-green-800' },\n  { value: 'Closed', label: 'Closed', color: 'bg-gray-100 text-gray-800' },\n  { value: 'Cancelled', label: 'Cancelled', color: 'bg-red-100 text-red-800' },\n];\n\nconst PRIORITY_OPTIONS = [\n  { value: 'Low', label: 'Low', color: 'bg-gray-100 text-gray-800' },\n  { value: 'Medium', label: 'Medium', color: 'bg-blue-100 text-blue-800' },\n  { value: 'High', label: 'High', color: 'bg-orange-100 text-orange-800' },\n  { value: 'Critical', label: 'Critical', color: 'bg-red-100 text-red-800' },\n];\n\nexport const AdvancedSearch = React.memo<AdvancedSearchProps>(({ \n  onFiltersChange, \n  tickets, \n  className = '' \n}) => {\n  const [filters, setFilters] = useState<SearchFilters>({\n    searchText: '',\n    status: [],\n    priority: [],\n    assignee: [],\n    category: [],\n    dateRange: undefined\n  });\n  \n  const [showAdvanced, setShowAdvanced] = useState(false);\n  const [dateRangeOpen, setDateRangeOpen] = useState(false);\n  const [fromDate, setFromDate] = useState<Date>();\n  const [toDate, setToDate] = useState<Date>();\n\n  // Extract unique values from tickets for filter options\n  const filterOptions = useMemo(() => {\n    const assignees = new Set<string>();\n    const categories = new Set<string>();\n    \n    tickets.forEach(ticket => {\n      if (ticket.assignedTo) assignees.add(ticket.assignedTo);\n      if (ticket.requestType) categories.add(ticket.requestType);\n    });\n    \n    return {\n      assignees: Array.from(assignees).map(a => ({ value: a, label: a })),\n      categories: Array.from(categories).map(c => ({ value: c, label: c }))\n    };\n  }, [tickets]);\n\n  // Debounced search text update\n  const updateSearchText = useCallback(\n    debounce((text: string) => {\n      const newFilters = { ...filters, searchText: text };\n      setFilters(newFilters);\n      onFiltersChange(newFilters);\n    }, 300),\n    [filters, onFiltersChange]\n  );\n\n  const handleFilterChange = useCallback((key: keyof SearchFilters, value: any) => {\n    const newFilters = { ...filters, [key]: value };\n    setFilters(newFilters);\n    onFiltersChange(newFilters);\n  }, [filters, onFiltersChange]);\n\n  const toggleArrayFilter = useCallback((key: 'status' | 'priority' | 'assignee' | 'category', value: string) => {\n    const currentArray = filters[key] || [];\n    const newArray = currentArray.includes(value)\n      ? currentArray.filter(item => item !== value)\n      : [...currentArray, value];\n    \n    handleFilterChange(key, newArray);\n  }, [filters, handleFilterChange]);\n\n  const handleDateRangeSelect = useCallback(() => {\n    if (fromDate && toDate) {\n      handleFilterChange('dateRange', { start: fromDate, end: toDate });\n      setDateRangeOpen(false);\n    }\n  }, [fromDate, toDate, handleFilterChange]);\n\n  const clearAllFilters = useCallback(() => {\n    const clearedFilters: SearchFilters = {\n      searchText: '',\n      status: [],\n      priority: [],\n      assignee: [],\n      category: [],\n      dateRange: undefined\n    };\n    \n    setFilters(clearedFilters);\n    setFromDate(undefined);\n    setToDate(undefined);\n    onFiltersChange(clearedFilters);\n  }, [onFiltersChange]);\n\n  const hasActiveFilters = useMemo(() => {\n    return (\n      (filters.searchText && filters.searchText.trim() !== '') ||\n      (filters.status && filters.status.length > 0) ||\n      (filters.priority && filters.priority.length > 0) ||\n      (filters.assignee && filters.assignee.length > 0) ||\n      (filters.category && filters.category.length > 0) ||\n      !!filters.dateRange\n    );\n  }, [filters]);\n\n  const activeFilterCount = useMemo(() => {\n    let count = 0;\n    if (filters.searchText?.trim()) count++;\n    if (filters.status?.length) count++;\n    if (filters.priority?.length) count++;\n    if (filters.assignee?.length) count++;\n    if (filters.category?.length) count++;\n    if (filters.dateRange) count++;\n    return count;\n  }, [filters]);\n\n  return (\n    <Card className={`${className}`}>\n      <CardHeader className=\"pb-4\">\n        <div className=\"flex items-center justify-between\">\n          <CardTitle className=\"text-lg flex items-center gap-2\">\n            <Search className=\"w-5 h-5\" />\n            Search & Filter\n          </CardTitle>\n          \n          <div className=\"flex items-center gap-2\">\n            {hasActiveFilters && (\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={clearAllFilters}\n                className=\"text-red-600 hover:text-red-700 hover:bg-red-50\"\n              >\n                <X className=\"w-4 h-4 mr-1\" />\n                Clear All\n              </Button>\n            )}\n            \n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={() => setShowAdvanced(!showAdvanced)}\n              className=\"relative\"\n            >\n              <SlidersHorizontal className=\"w-4 h-4 mr-2\" />\n              Filters\n              {activeFilterCount > 0 && (\n                <Badge \n                  variant=\"secondary\" \n                  className=\"absolute -top-2 -right-2 h-5 w-5 p-0 flex items-center justify-center text-xs bg-blue-500 text-white\"\n                >\n                  {activeFilterCount}\n                </Badge>\n              )}\n            </Button>\n          </div>\n        </div>\n      </CardHeader>\n      \n      <CardContent className=\"space-y-4\">\n        {/* Search Input */}\n        <div className=\"relative\">\n          <Search className=\"absolute left-3 top-3 h-4 w-4 text-gray-400\" />\n          <Input\n            placeholder=\"Search tickets by ID, subject, description, or user...\"\n            className=\"pl-10\"\n            onChange={(e) => updateSearchText(e.target.value)}\n          />\n        </div>\n\n        {/* Advanced Filters */}\n        {showAdvanced && (\n          <div className=\"space-y-4 pt-4 border-t\">\n            {/* Status Filter */}\n            <div className=\"space-y-2\">\n              <Label className=\"text-sm font-medium\">Status</Label>\n              <div className=\"flex flex-wrap gap-2\">\n                {STATUS_OPTIONS.map((option) => (\n                  <Button\n                    key={option.value}\n                    variant={filters.status?.includes(option.value) ? \"default\" : \"outline\"}\n                    size=\"sm\"\n                    onClick={() => toggleArrayFilter('status', option.value)}\n                    className=\"h-8\"\n                  >\n                    {option.label}\n                  </Button>\n                ))}\n              </div>\n            </div>\n\n            {/* Priority Filter */}\n            <div className=\"space-y-2\">\n              <Label className=\"text-sm font-medium\">Priority</Label>\n              <div className=\"flex flex-wrap gap-2\">\n                {PRIORITY_OPTIONS.map((option) => (\n                  <Button\n                    key={option.value}\n                    variant={filters.priority?.includes(option.value) ? \"default\" : \"outline\"}\n                    size=\"sm\"\n                    onClick={() => toggleArrayFilter('priority', option.value)}\n                    className=\"h-8\"\n                  >\n                    {option.label}\n                  </Button>\n                ))}\n              </div>\n            </div>\n\n            {/* Assignee Filter */}\n            {filterOptions.assignees.length > 0 && (\n              <div className=\"space-y-2\">\n                <Label className=\"text-sm font-medium\">Assigned To</Label>\n                <div className=\"grid grid-cols-2 md:grid-cols-3 gap-2\">\n                  {filterOptions.assignees.map((assignee) => (\n                    <div key={assignee.value} className=\"flex items-center space-x-2\">\n                      <Checkbox\n                        id={`assignee-${assignee.value}`}\n                        checked={filters.assignee?.includes(assignee.value)}\n                        onCheckedChange={() => toggleArrayFilter('assignee', assignee.value)}\n                      />\n                      <Label\n                        htmlFor={`assignee-${assignee.value}`}\n                        className=\"text-sm font-normal cursor-pointer\"\n                      >\n                        {assignee.label}\n                      </Label>\n                    </div>\n                  ))}\n                </div>\n              </div>\n            )}\n\n            {/* Category Filter */}\n            {filterOptions.categories.length > 0 && (\n              <div className=\"space-y-2\">\n                <Label className=\"text-sm font-medium\">Category</Label>\n                <div className=\"flex flex-wrap gap-2\">\n                  {filterOptions.categories.map((category) => (\n                    <Button\n                      key={category.value}\n                      variant={filters.category?.includes(category.value) ? \"default\" : \"outline\"}\n                      size=\"sm\"\n                      onClick={() => toggleArrayFilter('category', category.value)}\n                      className=\"h-8\"\n                    >\n                      {category.label}\n                    </Button>\n                  ))}\n                </div>\n              </div>\n            )}\n\n            {/* Date Range Filter */}\n            <div className=\"space-y-2\">\n              <Label className=\"text-sm font-medium\">Date Range</Label>\n              <Popover open={dateRangeOpen} onOpenChange={setDateRangeOpen}>\n                <PopoverTrigger asChild>\n                  <Button\n                    variant=\"outline\"\n                    className=\"w-full justify-start text-left font-normal\"\n                  >\n                    <Calendar className=\"mr-2 h-4 w-4\" />\n                    {filters.dateRange\n                      ? `${format(filters.dateRange.start, 'MMM dd, yyyy')} - ${format(filters.dateRange.end, 'MMM dd, yyyy')}`\n                      : 'Select date range'\n                    }\n                  </Button>\n                </PopoverTrigger>\n                <PopoverContent className=\"w-auto p-0\" align=\"start\">\n                  <div className=\"p-4 space-y-4\">\n                    <div className=\"space-y-2\">\n                      <Label>From Date</Label>\n                      <CalendarComponent\n                        mode=\"single\"\n                        selected={fromDate}\n                        onSelect={setFromDate}\n                        disabled={(date) => date > new Date() || (toDate && date > toDate)}\n                        initialFocus\n                      />\n                    </div>\n                    \n                    {fromDate && (\n                      <div className=\"space-y-2\">\n                        <Label>To Date</Label>\n                        <CalendarComponent\n                          mode=\"single\"\n                          selected={toDate}\n                          onSelect={setToDate}\n                          disabled={(date) => date > new Date() || date < fromDate}\n                        />\n                      </div>\n                    )}\n                    \n                    <div className=\"flex gap-2 pt-2\">\n                      <Button\n                        size=\"sm\"\n                        onClick={handleDateRangeSelect}\n                        disabled={!fromDate || !toDate}\n                        className=\"flex-1\"\n                      >\n                        Apply\n                      </Button>\n                      <Button\n                        size=\"sm\"\n                        variant=\"outline\"\n                        onClick={() => {\n                          setFromDate(undefined);\n                          setToDate(undefined);\n                          handleFilterChange('dateRange', undefined);\n                          setDateRangeOpen(false);\n                        }}\n                        className=\"flex-1\"\n                      >\n                        Clear\n                      </Button>\n                    </div>\n                  </div>\n                </PopoverContent>\n              </Popover>\n            </div>\n          </div>\n        )}\n\n        {/* Active Filters Display */}\n        {hasActiveFilters && (\n          <div className=\"pt-4 border-t\">\n            <div className=\"flex flex-wrap gap-2\">\n              {filters.searchText && (\n                <Badge variant=\"secondary\" className=\"gap-1\">\n                  <Search className=\"w-3 h-3\" />\n                  \"{filters.searchText}\"\n                  <X \n                    className=\"w-3 h-3 cursor-pointer hover:text-red-600\" \n                    onClick={() => handleFilterChange('searchText', '')}\n                  />\n                </Badge>\n              )}\n              \n              {filters.status?.map(status => (\n                <Badge key={status} variant=\"secondary\" className=\"gap-1\">\n                  <Tag className=\"w-3 h-3\" />\n                  {status}\n                  <X \n                    className=\"w-3 h-3 cursor-pointer hover:text-red-600\" \n                    onClick={() => toggleArrayFilter('status', status)}\n                  />\n                </Badge>\n              ))}\n              \n              {filters.priority?.map(priority => (\n                <Badge key={priority} variant=\"secondary\" className=\"gap-1\">\n                  {priority} Priority\n                  <X \n                    className=\"w-3 h-3 cursor-pointer hover:text-red-600\" \n                    onClick={() => toggleArrayFilter('priority', priority)}\n                  />\n                </Badge>\n              ))}\n              \n              {filters.assignee?.map(assignee => (\n                <Badge key={assignee} variant=\"secondary\" className=\"gap-1\">\n                  <User className=\"w-3 h-3\" />\n                  {assignee}\n                  <X \n                    className=\"w-3 h-3 cursor-pointer hover:text-red-600\" \n                    onClick={() => toggleArrayFilter('assignee', assignee)}\n                  />\n                </Badge>\n              ))}\n              \n              {filters.category?.map(category => (\n                <Badge key={category} variant=\"secondary\" className=\"gap-1\">\n                  {category}\n                  <X \n                    className=\"w-3 h-3 cursor-pointer hover:text-red-600\" \n                    onClick={() => toggleArrayFilter('category', category)}\n                  />\n                </Badge>\n              ))}\n              \n              {filters.dateRange && (\n                <Badge variant=\"secondary\" className=\"gap-1\">\n                  <Calendar className=\"w-3 h-3\" />\n                  {format(filters.dateRange.start, 'MMM dd')} - {format(filters.dateRange.end, 'MMM dd')}\n                  <X \n                    className=\"w-3 h-3 cursor-pointer hover:text-red-600\" \n                    onClick={() => handleFilterChange('dateRange', undefined)}\n                  />\n                </Badge>\n              )}\n            </div>\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n});\n\nAdvancedSearch.displayName = 'AdvancedSearch';\n\n// Utility function for debouncing\nfunction debounce<T extends (...args: any[]) => any>(\n  func: T,\n  delay: number\n): (...args: Parameters<T>) => void {\n  let timeoutId: NodeJS.Timeout;\n  return (...args: Parameters<T>) => {\n    clearTimeout(timeoutId);\n    timeoutId = setTimeout(() => func(...args), delay);\n  };\n}"