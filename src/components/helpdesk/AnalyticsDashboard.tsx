import React, { useMemo, useState, useCallback } from 'react';\nimport {\n  BarChart,\n  Bar,\n  XAxis,\n  YAxis,\n  CartesianGrid,\n  Tooltip,\n  ResponsiveContainer,\n  PieChart,\n  Pie,\n  Cell,\n  LineChart,\n  Line,\n  Area,\n  AreaChart,\n} from 'recharts';\nimport {\n  Calendar,\n  Clock,\n  TrendingUp,\n  Users,\n  AlertTriangle,\n  CheckCircle,\n  Timer,\n  Target,\n  Filter,\n  Download,\n  RefreshCw,\n} from 'lucide-react';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select';\nimport { DatePickerWithRange } from '@/components/ui/date-picker-with-range';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { Progress } from '@/components/ui/progress';\nimport type { HelpdeskTicket } from '@/types/helpdesk';\nimport { useHelpdeskStoreEnhanced } from '@/store/helpdeskStoreEnhanced';\nimport { format, subDays, startOfDay, endOfDay } from 'date-fns';\nimport type { DateRange } from 'react-day-picker';\n\ninterface AnalyticsDashboardProps {\n  className?: string;\n}\n\ninterface MetricCardProps {\n  title: string;\n  value: string | number;\n  subtitle?: string;\n  trend?: {\n    value: number;\n    isPositive: boolean;\n  };\n  icon: React.ReactNode;\n  color?: 'blue' | 'green' | 'red' | 'yellow' | 'purple';\n}\n\ninterface ChartData {\n  name: string;\n  value: number;\n  [key: string]: any;\n}\n\ntype TimeRange = '7d' | '30d' | '90d' | 'custom';\ntype MetricType = 'tickets' | 'resolution' | 'satisfaction' | 'workload';\n\nconst COLORS = {\n  blue: '#3B82F6',\n  green: '#10B981',\n  red: '#EF4444',\n  yellow: '#F59E0B',\n  purple: '#8B5CF6',\n  gray: '#6B7280',\n};\n\nconst STATUS_COLORS = {\n  Open: COLORS.blue,\n  'In Progress': COLORS.yellow,\n  Resolved: COLORS.green,\n  Closed: COLORS.gray,\n  Cancelled: COLORS.red,\n};\n\nconst PRIORITY_COLORS = {\n  Low: COLORS.green,\n  Medium: COLORS.blue,\n  High: COLORS.yellow,\n  Critical: COLORS.red,\n};\n\nexport const AnalyticsDashboard = React.memo<AnalyticsDashboardProps>(({ className = '' }) => {\n  const [timeRange, setTimeRange] = useState<TimeRange>('30d');\n  const [dateRange, setDateRange] = useState<DateRange | undefined>();\n  const [selectedMetric, setSelectedMetric] = useState<MetricType>('tickets');\n  const [isRefreshing, setIsRefreshing] = useState(false);\n\n  const { tickets, analytics } = useHelpdeskStoreEnhanced();\n\n  // Calculate date range for filtering\n  const effectiveDateRange = useMemo(() => {\n    if (timeRange === 'custom' && dateRange?.from && dateRange?.to) {\n      return { from: dateRange.from, to: dateRange.to };\n    }\n    \n    const days = {\n      '7d': 7,\n      '30d': 30,\n      '90d': 90,\n    }[timeRange] || 30;\n    \n    return {\n      from: startOfDay(subDays(new Date(), days)),\n      to: endOfDay(new Date()),\n    };\n  }, [timeRange, dateRange]);\n\n  // Filter tickets by date range\n  const filteredTickets = useMemo(() => {\n    return tickets.filter(ticket => {\n      const ticketDate = new Date(ticket.createdAt);\n      return ticketDate >= effectiveDateRange.from && ticketDate <= effectiveDateRange.to;\n    });\n  }, [tickets, effectiveDateRange]);\n\n  // Calculate metrics\n  const metrics = useMemo(() => {\n    const totalTickets = filteredTickets.length;\n    const resolvedTickets = filteredTickets.filter(t => t.status === 'Resolved' || t.status === 'Closed').length;\n    const openTickets = filteredTickets.filter(t => t.status === 'Open' || t.status === 'In Progress').length;\n    const criticalTickets = filteredTickets.filter(t => t.urgency === 'Critical').length;\n    \n    // Calculate resolution rate\n    const resolutionRate = totalTickets > 0 ? (resolvedTickets / totalTickets) * 100 : 0;\n    \n    // Calculate average resolution time (mock calculation)\n    const avgResolutionHours = resolvedTickets > 0 ? \n      filteredTickets\n        .filter(t => t.status === 'Resolved' || t.status === 'Closed')\n        .reduce((sum, ticket) => {\n          const created = new Date(ticket.createdAt);\n          const resolved = new Date(ticket.updatedAt || ticket.createdAt);\n          return sum + (resolved.getTime() - created.getTime()) / (1000 * 60 * 60);\n        }, 0) / resolvedTickets : 0;\n    \n    // Previous period for trend calculation (simplified)\n    const prevPeriodTickets = tickets.filter(ticket => {\n      const ticketDate = new Date(ticket.createdAt);\n      const periodLength = effectiveDateRange.to.getTime() - effectiveDateRange.from.getTime();\n      const prevStart = new Date(effectiveDateRange.from.getTime() - periodLength);\n      const prevEnd = effectiveDateRange.from;\n      return ticketDate >= prevStart && ticketDate < prevEnd;\n    }).length;\n    \n    const ticketsTrend = prevPeriodTickets > 0 ? \n      ((totalTickets - prevPeriodTickets) / prevPeriodTickets) * 100 : 0;\n    \n    return {\n      totalTickets,\n      openTickets,\n      resolvedTickets,\n      criticalTickets,\n      resolutionRate,\n      avgResolutionHours,\n      ticketsTrend,\n    };\n  }, [filteredTickets, tickets, effectiveDateRange]);\n\n  // Chart data\n  const statusDistribution: ChartData[] = useMemo(() => {\n    const statusCounts = filteredTickets.reduce((acc, ticket) => {\n      acc[ticket.status] = (acc[ticket.status] || 0) + 1;\n      return acc;\n    }, {} as Record<string, number>);\n    \n    return Object.entries(statusCounts).map(([status, count]) => ({\n      name: status,\n      value: count,\n    }));\n  }, [filteredTickets]);\n\n  const priorityDistribution: ChartData[] = useMemo(() => {\n    const priorityCounts = filteredTickets.reduce((acc, ticket) => {\n      acc[ticket.urgency] = (acc[ticket.urgency] || 0) + 1;\n      return acc;\n    }, {} as Record<string, number>);\n    \n    return Object.entries(priorityCounts).map(([priority, count]) => ({\n      name: priority,\n      value: count,\n    }));\n  }, [filteredTickets]);\n\n  // Tickets over time (daily)\n  const ticketTrend: ChartData[] = useMemo(() => {\n    const days = {};\n    \n    // Initialize all days in range\n    for (let d = new Date(effectiveDateRange.from); d <= effectiveDateRange.to; d.setDate(d.getDate() + 1)) {\n      const dateKey = format(d, 'MMM dd');\n      days[dateKey] = { created: 0, resolved: 0 };\n    }\n    \n    // Count tickets by day\n    filteredTickets.forEach(ticket => {\n      const createdDay = format(new Date(ticket.createdAt), 'MMM dd');\n      if (days[createdDay]) {\n        days[createdDay].created++;\n      }\n      \n      if (ticket.status === 'Resolved' || ticket.status === 'Closed') {\n        const resolvedDay = format(new Date(ticket.updatedAt || ticket.createdAt), 'MMM dd');\n        if (days[resolvedDay]) {\n          days[resolvedDay].resolved++;\n        }\n      }\n    });\n    \n    return Object.entries(days).map(([date, counts]) => ({\n      name: date,\n      created: counts.created,\n      resolved: counts.resolved,\n    }));\n  }, [filteredTickets, effectiveDateRange]);\n\n  // Team performance\n  const teamPerformance: ChartData[] = useMemo(() => {\n    const assigneeCounts = filteredTickets.reduce((acc, ticket) => {\n      const assignee = ticket.assignedTo || 'Unassigned';\n      if (!acc[assignee]) {\n        acc[assignee] = { total: 0, resolved: 0 };\n      }\n      acc[assignee].total++;\n      if (ticket.status === 'Resolved' || ticket.status === 'Closed') {\n        acc[assignee].resolved++;\n      }\n      return acc;\n    }, {} as Record<string, { total: number; resolved: number }>);\n    \n    return Object.entries(assigneeCounts)\n      .map(([assignee, counts]) => ({\n        name: assignee.split('.').map(n => n.charAt(0).toUpperCase() + n.slice(1)).join(' '),\n        total: counts.total,\n        resolved: counts.resolved,\n        rate: counts.total > 0 ? (counts.resolved / counts.total) * 100 : 0,\n      }))\n      .sort((a, b) => b.total - a.total)\n      .slice(0, 10);\n  }, [filteredTickets]);\n\n  // Handlers\n  const handleRefresh = useCallback(async () => {\n    setIsRefreshing(true);\n    // Simulate refresh delay\n    await new Promise(resolve => setTimeout(resolve, 1000));\n    setIsRefreshing(false);\n  }, []);\n\n  const handleExportData = useCallback(() => {\n    const exportData = {\n      metrics,\n      statusDistribution,\n      priorityDistribution,\n      ticketTrend,\n      teamPerformance,\n      dateRange: effectiveDateRange,\n    };\n    \n    const blob = new Blob([JSON.stringify(exportData, null, 2)], { \n      type: 'application/json' \n    });\n    const url = URL.createObjectURL(blob);\n    const link = document.createElement('a');\n    link.href = url;\n    link.download = `helpdesk-analytics-${format(new Date(), 'yyyy-MM-dd')}.json`;\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n    URL.revokeObjectURL(url);\n  }, [metrics, statusDistribution, priorityDistribution, ticketTrend, teamPerformance, effectiveDateRange]);\n\n  return (\n    <div className={`space-y-6 ${className}`}>\n      {/* Header */}\n      <div className=\"flex justify-between items-center\">\n        <div>\n          <h2 className=\"text-2xl font-bold tracking-tight\">Analytics Dashboard</h2>\n          <p className=\"text-muted-foreground\">\n            Monitor helpdesk performance and ticket trends\n          </p>\n        </div>\n        \n        <div className=\"flex items-center gap-2\">\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            onClick={handleRefresh}\n            disabled={isRefreshing}\n            className=\"gap-1\"\n          >\n            <RefreshCw className={`w-4 h-4 ${isRefreshing ? 'animate-spin' : ''}`} />\n            Refresh\n          </Button>\n          \n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            onClick={handleExportData}\n            className=\"gap-1\"\n          >\n            <Download className=\"w-4 h-4\" />\n            Export\n          </Button>\n        </div>\n      </div>\n\n      {/* Time Range Controls */}\n      <div className=\"flex flex-wrap items-center gap-4\">\n        <div className=\"flex items-center gap-2\">\n          <Calendar className=\"w-4 h-4 text-muted-foreground\" />\n          <span className=\"text-sm font-medium\">Time Range:</span>\n        </div>\n        \n        <Select value={timeRange} onValueChange={(value: TimeRange) => setTimeRange(value)}>\n          <SelectTrigger className=\"w-[140px]\">\n            <SelectValue />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"7d\">Last 7 days</SelectItem>\n            <SelectItem value=\"30d\">Last 30 days</SelectItem>\n            <SelectItem value=\"90d\">Last 90 days</SelectItem>\n            <SelectItem value=\"custom\">Custom range</SelectItem>\n          </SelectContent>\n        </Select>\n        \n        {timeRange === 'custom' && (\n          <DatePickerWithRange\n            date={dateRange}\n            onDateChange={setDateRange}\n            className=\"w-[280px]\"\n          />\n        )}\n      </div>\n\n      {/* Key Metrics */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        <MetricCard\n          title=\"Total Tickets\"\n          value={metrics.totalTickets}\n          subtitle={`${metrics.openTickets} active`}\n          trend={{\n            value: Math.abs(metrics.ticketsTrend),\n            isPositive: metrics.ticketsTrend >= 0,\n          }}\n          icon={<Target className=\"w-4 h-4\" />}\n          color=\"blue\"\n        />\n        \n        <MetricCard\n          title=\"Resolution Rate\"\n          value={`${metrics.resolutionRate.toFixed(1)}%`}\n          subtitle={`${metrics.resolvedTickets} resolved`}\n          icon={<CheckCircle className=\"w-4 h-4\" />}\n          color=\"green\"\n        />\n        \n        <MetricCard\n          title=\"Avg Resolution Time\"\n          value={`${metrics.avgResolutionHours.toFixed(1)}h`}\n          subtitle=\"Time to resolve\"\n          icon={<Clock className=\"w-4 h-4\" />}\n          color=\"purple\"\n        />\n        \n        <MetricCard\n          title=\"Critical Issues\"\n          value={metrics.criticalTickets}\n          subtitle=\"High priority\"\n          icon={<AlertTriangle className=\"w-4 h-4\" />}\n          color=\"red\"\n        />\n      </div>\n\n      {/* Charts */}\n      <Tabs defaultValue=\"overview\" className=\"space-y-4\">\n        <TabsList>\n          <TabsTrigger value=\"overview\">Overview</TabsTrigger>\n          <TabsTrigger value=\"trends\">Trends</TabsTrigger>\n          <TabsTrigger value=\"team\">Team Performance</TabsTrigger>\n          <TabsTrigger value=\"sla\">SLA Metrics</TabsTrigger>\n        </TabsList>\n        \n        <TabsContent value=\"overview\" className=\"space-y-4\">\n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-4\">\n            {/* Status Distribution */}\n            <Card>\n              <CardHeader>\n                <CardTitle>Ticket Status Distribution</CardTitle>\n                <CardDescription>Current status breakdown</CardDescription>\n              </CardHeader>\n              <CardContent>\n                <ResponsiveContainer width=\"100%\" height={300}>\n                  <PieChart>\n                    <Pie\n                      data={statusDistribution}\n                      cx=\"50%\"\n                      cy=\"50%\"\n                      outerRadius={80}\n                      fill=\"#8884d8\"\n                      dataKey=\"value\"\n                      label={({ name, percent }) => `${name}: ${(percent * 100).toFixed(0)}%`}\n                    >\n                      {statusDistribution.map((entry, index) => (\n                        <Cell key={`cell-${index}`} fill={STATUS_COLORS[entry.name] || COLORS.gray} />\n                      ))}\n                    </Pie>\n                    <Tooltip />\n                  </PieChart>\n                </ResponsiveContainer>\n              </CardContent>\n            </Card>\n            \n            {/* Priority Distribution */}\n            <Card>\n              <CardHeader>\n                <CardTitle>Priority Distribution</CardTitle>\n                <CardDescription>Tickets by priority level</CardDescription>\n              </CardHeader>\n              <CardContent>\n                <ResponsiveContainer width=\"100%\" height={300}>\n                  <BarChart data={priorityDistribution}>\n                    <CartesianGrid strokeDasharray=\"3 3\" />\n                    <XAxis dataKey=\"name\" />\n                    <YAxis />\n                    <Tooltip />\n                    <Bar dataKey=\"value\">\n                      {priorityDistribution.map((entry, index) => (\n                        <Cell key={`cell-${index}`} fill={PRIORITY_COLORS[entry.name] || COLORS.gray} />\n                      ))}\n                    </Bar>\n                  </BarChart>\n                </ResponsiveContainer>\n              </CardContent>\n            </Card>\n          </div>\n        </TabsContent>\n        \n        <TabsContent value=\"trends\" className=\"space-y-4\">\n          {/* Ticket Trends */}\n          <Card>\n            <CardHeader>\n              <CardTitle>Ticket Volume Trends</CardTitle>\n              <CardDescription>Daily ticket creation and resolution</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <ResponsiveContainer width=\"100%\" height={400}>\n                <LineChart data={ticketTrend}>\n                  <CartesianGrid strokeDasharray=\"3 3\" />\n                  <XAxis dataKey=\"name\" />\n                  <YAxis />\n                  <Tooltip />\n                  <Line \n                    type=\"monotone\" \n                    dataKey=\"created\" \n                    stroke={COLORS.blue} \n                    name=\"Created\"\n                    strokeWidth={2}\n                  />\n                  <Line \n                    type=\"monotone\" \n                    dataKey=\"resolved\" \n                    stroke={COLORS.green} \n                    name=\"Resolved\"\n                    strokeWidth={2}\n                  />\n                </LineChart>\n              </ResponsiveContainer>\n            </CardContent>\n          </Card>\n        </TabsContent>\n        \n        <TabsContent value=\"team\" className=\"space-y-4\">\n          {/* Team Performance */}\n          <Card>\n            <CardHeader>\n              <CardTitle>Team Performance</CardTitle>\n              <CardDescription>Resolution rates by team member</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-4\">\n                {teamPerformance.map((member, index) => (\n                  <div key={member.name} className=\"space-y-2\">\n                    <div className=\"flex justify-between items-center text-sm\">\n                      <span className=\"font-medium\">{member.name}</span>\n                      <span className=\"text-muted-foreground\">\n                        {member.resolved}/{member.total} ({member.rate.toFixed(0)}%)\n                      </span>\n                    </div>\n                    <Progress value={member.rate} className=\"h-2\" />\n                  </div>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n        \n        <TabsContent value=\"sla\" className=\"space-y-4\">\n          {/* SLA Metrics - Placeholder */}\n          <Card>\n            <CardHeader>\n              <CardTitle>SLA Performance</CardTitle>\n              <CardDescription>Service Level Agreement metrics</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-center py-8 text-muted-foreground\">\n                <Timer className=\"w-12 h-12 mx-auto mb-4\" />\n                <p>SLA tracking coming soon...</p>\n                <p className=\"text-sm\">Integration with deadline and escalation system in progress.</p>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n});\n\nAnalyticsDashboard.displayName = 'AnalyticsDashboard';\n\n// Metric Card Component\nconst MetricCard: React.FC<MetricCardProps> = ({\n  title,\n  value,\n  subtitle,\n  trend,\n  icon,\n  color = 'blue',\n}) => {\n  const colorClasses = {\n    blue: 'bg-blue-50 text-blue-700 border-blue-200 dark:bg-blue-950 dark:text-blue-300',\n    green: 'bg-green-50 text-green-700 border-green-200 dark:bg-green-950 dark:text-green-300',\n    red: 'bg-red-50 text-red-700 border-red-200 dark:bg-red-950 dark:text-red-300',\n    yellow: 'bg-yellow-50 text-yellow-700 border-yellow-200 dark:bg-yellow-950 dark:text-yellow-300',\n    purple: 'bg-purple-50 text-purple-700 border-purple-200 dark:bg-purple-950 dark:text-purple-300',\n  };\n\n  return (\n    <Card>\n      <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n        <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n          {title}\n        </CardTitle>\n        <div className={`p-2 rounded-md ${colorClasses[color]}`}>\n          {icon}\n        </div>\n      </CardHeader>\n      <CardContent>\n        <div className=\"text-2xl font-bold\">{value}</div>\n        <div className=\"flex items-center justify-between\">\n          {subtitle && (\n            <p className=\"text-xs text-muted-foreground\">{subtitle}</p>\n          )}\n          {trend && (\n            <Badge\n              variant={trend.isPositive ? 'default' : 'destructive'}\n              className=\"text-xs\"\n            >\n              <TrendingUp className=\"w-3 h-3 mr-1\" />\n              {trend.value.toFixed(1)}%\n            </Badge>\n          )}\n        </div>\n      </CardContent>\n    </Card>\n  );\n};"